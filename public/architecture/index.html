<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Architecture — Pi for Excel</title>
  <meta name="description" content="Architecture snapshot of Pi for Excel 0.9.0-pre, generated by Pi. Boot sequence, tool pipeline, auth, extensions, recovery, context injection, and more." />
  <link rel="icon" href="/assets/icon-32.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }

    :root {
      --bg: oklch(0.985 0.002 90);
      --fg: oklch(0.18 0 0);
      --muted: oklch(0.50 0 0);
      --faint: oklch(0.65 0 0);
      --green: oklch(0.45 0.12 160);
      --green-strong: oklch(0.40 0.12 160);
      --green-light: oklch(0.45 0.12 160 / 0.08);
      --green-lighter: oklch(0.45 0.12 160 / 0.04);
      --green-border: oklch(0.45 0.12 160 / 0.14);
      --border: oklch(0 0 0 / 0.08);
      --border-light: oklch(0 0 0 / 0.05);
      --card-bg: oklch(1 0 0 / 0.72);
      --card-border: oklch(1 0 0 / 0.50);
      --shadow: 0 2px 8px oklch(0 0 0 / 0.06), 0 0.5px 0 oklch(0 0 0 / 0.04);
      --shadow-lg: 0 12px 40px oklch(0 0 0 / 0.08), 0 2px 6px oklch(0 0 0 / 0.05);
      --glass-highlight: inset 0 1px 0 0 oklch(1 0 0 / 0.60), inset 1px 0 0 0 oklch(1 0 0 / 0.30);
      --glass-inner: inset 0 -1px 0 0 oklch(0 0 0 / 0.04), inset -1px 0 0 0 oklch(0 0 0 / 0.02);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-xs: 6px;
      --font: 'DM Sans', ui-sans-serif, system-ui, sans-serif;
      --font-display: 'Instrument Serif', Georgia, serif;
      --font-mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;

      /* Accent tints — oklch-based, harmonized with the green primary */
      --blue: oklch(0.50 0.12 240);
      --blue-light: oklch(0.50 0.12 240 / 0.07);
      --blue-border: oklch(0.50 0.12 240 / 0.14);
      --amber: oklch(0.55 0.14 80);
      --amber-light: oklch(0.55 0.14 80 / 0.07);
      --amber-border: oklch(0.55 0.14 80 / 0.14);
      --rose: oklch(0.52 0.14 15);
      --rose-light: oklch(0.52 0.14 15 / 0.07);
      --rose-border: oklch(0.52 0.14 15 / 0.14);
      --violet: oklch(0.50 0.14 290);
      --violet-light: oklch(0.50 0.14 290 / 0.07);
      --violet-border: oklch(0.50 0.14 290 / 0.14);
      --orange: oklch(0.55 0.16 55);
      --orange-light: oklch(0.55 0.16 55 / 0.07);
      --orange-border: oklch(0.55 0.16 55 / 0.14);
      --cyan: oklch(0.52 0.10 200);
      --cyan-light: oklch(0.52 0.10 200 / 0.07);
      --cyan-border: oklch(0.52 0.10 200 / 0.14);
      --pink: oklch(0.52 0.14 340);
      --pink-light: oklch(0.52 0.14 340 / 0.07);
      --pink-border: oklch(0.52 0.14 340 / 0.14);
    }

    body {
      font-family: var(--font);
      font-size: 15px;
      line-height: 1.6;
      color: var(--fg);
      background-color: var(--bg);
      background-image:
        linear-gradient(oklch(0.45 0.08 160 / 0.04) 1px, transparent 1px),
        linear-gradient(90deg, oklch(0.45 0.08 160 / 0.04) 1px, transparent 1px);
      background-size: 80px 21px;
      background-position: -1px -1px;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Layout ── */
    .page { max-width: 860px; margin: 0 auto; padding: 0 24px; }

    /* ── Nav (matches landing) ── */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0 0;
      gap: 12px;
      flex-wrap: wrap;
    }
    .nav-mark {
      font-family: var(--font);
      font-size: 15px;
      font-weight: 700;
      color: var(--green);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .nav-mark__logo {
      font-family: var(--font-display);
      font-size: 20px;
      line-height: 1;
    }
    .exp-badge {
      display: inline-flex;
      align-items: center;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 9px;
      border-radius: 999px;
      background: oklch(0.55 0.15 50 / 0.10);
      color: oklch(0.48 0.12 50);
      border: 1px solid oklch(0.55 0.15 50 / 0.18);
      margin-left: 10px;
    }
    .nav-links { display: flex; align-items: center; gap: 20px; }
    .nav-links a {
      font-size: 13px;
      color: var(--muted);
      text-decoration: none;
      transition: color 0.15s;
    }
    .nav-links a:hover { color: var(--fg); }
    .nav-links a.active { color: var(--fg); font-weight: 600; }
    .gh-link { display: inline-flex; align-items: center; gap: 5px; }
    .gh-link svg { width: 16px; height: 16px; fill: currentColor; }

    /* ── Hero ── */
    .hero {
      padding: 64px 0 0;
      position: relative;
    }
    .hero-eyebrow {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--green);
      margin-bottom: 10px;
    }
    .hero h1 {
      font-family: var(--font-display);
      font-size: clamp(36px, 7vw, 52px);
      font-weight: 400;
      line-height: 1.05;
      letter-spacing: -0.02em;
      margin-bottom: 20px;
    }
    .hero-sub {
      font-size: 15px;
      line-height: 1.7;
      color: var(--muted);
      max-width: 520px;
      margin-bottom: 0;
    }
    .hero-version {
      margin-top: 20px;
      font-family: var(--font-mono);
      font-size: 11.5px;
      color: var(--faint);
      line-height: 1.5;
    }
    .hero-version a { color: var(--faint); text-decoration: none; }
    .hero-version a:hover { color: var(--green); text-decoration: underline; }
    .hero-sep { color: oklch(0 0 0 / 0.15); margin: 0 3px; }

    /* ── TOC (sticky sidebar on wide screens, horizontal bar on small) ── */
    .content-wrap {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 0 32px;
      padding-top: 48px;
    }
    .toc {
      display: block; /* override nav's display:flex */
      position: sticky;
      top: 20px;
      align-self: start;
      grid-row: 1 / -1;
      max-height: calc(100dvh - 40px);
      overflow-y: auto;
      padding: 0 0 20px;
    }
    .toc::-webkit-scrollbar { width: 2px; }
    .toc::-webkit-scrollbar-thumb { background: oklch(0 0 0 / 0.10); border-radius: 2px; }
    .toc-title {
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--faint);
      padding-bottom: 8px;
      margin-bottom: 4px;
      border-bottom: 1px solid var(--border-light);
    }
    .toc a {
      display: block;
      font-size: 11px;
      color: var(--muted);
      text-decoration: none;
      padding: 4px 8px 4px 10px;
      border-radius: 4px;
      border-left: 2px solid transparent;
      transition: all 0.15s;
      line-height: 1.3;
      margin-bottom: 0;
    }
    .toc a:hover { color: var(--fg); background: oklch(0 0 0 / 0.03); }
    .toc a.active { color: var(--fg); font-weight: 600; border-left-color: var(--green); background: var(--green-lighter); }
    .toc a.toc-sub {
      padding-left: 22px;
      font-size: 10.5px;
      color: var(--faint);
    }
    .toc a.toc-sub.active {
      color: var(--fg);
      font-weight: 600;
      border-left-color: transparent;
      background: none;
    }
    .toc a.toc-parent-active {
      color: var(--fg);
      font-weight: 600;
      border-left-color: oklch(0.55 0.12 152);
    }

    @media (max-width: 900px) {
      .content-wrap { grid-template-columns: 1fr; padding-top: 0; }
      .toc {
        position: sticky; top: 0; z-index: 200;
        max-height: none; display: flex; gap: 4px; align-items: center;
        overflow-x: auto; -webkit-overflow-scrolling: touch;
        background: var(--bg); border-bottom: 1px solid var(--border);
        padding: 10px 0; margin: 32px -24px 0; padding-left: 24px; padding-right: 24px;
        grid-row: auto;
      }
      .toc::-webkit-scrollbar { display: none; }
      .toc-title { display: none; }
      .toc a.toc-sub { display: none; }
      .toc a {
        white-space: nowrap; flex-shrink: 0; border-left: none;
        border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0;
        padding: 6px 10px; font-size: 11px;
      }
      .toc a.active { border-left: none; border-bottom-color: var(--green); background: var(--card-bg); }
      .main { padding-top: 24px; }
      .sec-head { scroll-margin-top: 56px; }
    }

    .main { min-width: 0; }

    /* ── Section headings ── */
    .sec-head {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--green);
      margin-top: 52px;
      padding: 12px 0 18px;
      border-top: 1px solid var(--border);
    }
    .sec-head:first-child { margin-top: 0; border-top: none; }
    h3 {
      font-family: var(--font);
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--fg);
    }
    h3.section-serif {
      font-family: var(--font-display);
      font-size: clamp(22px, 3.5vw, 28px);
      font-weight: 400;
      line-height: 1.25;
      margin-bottom: 14px;
    }

    /* ── Glass card (matches landing) ── */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 20px 22px;
      margin-bottom: 12px;
      box-shadow: var(--shadow), var(--glass-highlight), var(--glass-inner);
      backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      -webkit-backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      transition: border-color 0.15s;
    }
    .card:hover { border-color: oklch(0 0 0 / 0.12); }
    .card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .card-icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      flex-shrink: 0;
    }
    .card-title {
      font-weight: 600;
      font-size: 14px;
    }
    .card-desc {
      font-size: 13.5px;
      color: var(--muted);
      line-height: 1.6;
    }
    .card-desc code {
      font-family: var(--font-mono);
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
      color: var(--fg);
    }

    /* Card grids */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .card-grid .card { margin-bottom: 0; }
    @media (max-width: 640px) { .card-grid { grid-template-columns: 1fr; } }

    /* Two-column layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 700px) { .two-col { grid-template-columns: 1fr; } }

    /* ── Accent left-borders ── */
    .accent-green  { border-left: 3px solid var(--green); }
    .accent-blue   { border-left: 3px solid var(--blue); }
    .accent-amber  { border-left: 3px solid var(--amber); }
    .accent-rose   { border-left: 3px solid var(--rose); }
    .accent-violet { border-left: 3px solid var(--violet); }
    .accent-orange { border-left: 3px solid var(--orange); }
    .accent-cyan   { border-left: 3px solid var(--cyan); }
    .accent-pink   { border-left: 3px solid var(--pink); }

    /* ── Flow (vertical pipeline) ── */
    /* ── Awareness layers ── */
    .awareness {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 12px 0 8px;
    }
    .awareness__layer {
      border-radius: var(--radius-sm);
      padding: 12px 16px 10px;
    }
    .awareness__layer--core  { background: oklch(0.97 0.015 160); border: 1px solid oklch(0.88 0.04 160); }
    .awareness__layer--turn  { background: oklch(0.97 0.015 250); border: 1px solid oklch(0.88 0.04 250); }
    .awareness__layer--demand{ background: oklch(0.97 0.015 80);  border: 1px solid oklch(0.88 0.04 80);  }
    .awareness__layer--persist{background: oklch(0.97 0.01 0);    border: 1px solid oklch(0.88 0 0);      }
    .awareness__bar {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .awareness__freq {
      font-weight: 650;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .awareness__layer--core   .awareness__freq { color: oklch(0.40 0.08 160); }
    .awareness__layer--turn   .awareness__freq { color: oklch(0.40 0.08 250); }
    .awareness__layer--demand .awareness__freq { color: oklch(0.42 0.06 80);  }
    .awareness__layer--persist .awareness__freq{ color: oklch(0.40 0 0);      }
    .awareness__items {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .awareness__tag {
      font-size: 12px;
      font-weight: 500;
      padding: 3px 10px;
      border-radius: 20px;
      background: white;
      color: var(--tag-clr, var(--muted));
      border: 1px solid oklch(0 0 0 / 0.08);
      white-space: nowrap;
    }
    .awareness__note {
      font-size: 11.5px;
      color: var(--faint);
      margin-top: 8px;
      line-height: 1.45;
    }

    /* ── System topology ── */
    .sys-topo {
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      grid-template-rows: auto auto auto;
      gap: 0;
      margin: 24px 0 20px;
      padding: 32px 20px 28px;
      border-radius: var(--radius);
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .sys-topo__center {
      grid-column: 2;
      grid-row: 2;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .sys-topo__hub {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 20px 28px;
      border-radius: var(--radius-sm);
      background: var(--green-light);
      border: 2px solid var(--green-border);
      color: var(--green);
      font-weight: 700;
      font-size: 14px;
    }
    .sys-topo__ring {
      display: contents;
    }
    .sys-topo__spoke {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sys-topo__spoke--top {
      grid-column: 2;
      grid-row: 1;
      padding-bottom: 18px;
    }
    .sys-topo__spoke--left {
      grid-column: 1;
      grid-row: 2;
      justify-content: flex-end;
      padding-right: 24px;
    }
    .sys-topo__spoke--right {
      grid-column: 3;
      grid-row: 2;
      justify-content: flex-start;
      padding-left: 24px;
    }
    .sys-topo__spoke--bottom {
      grid-column: 2;
      grid-row: 3;
      padding-top: 18px;
    }
    .sys-topo__node {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 12px 18px 10px;
      border-radius: var(--radius-xs);
      border: 1px solid oklch(0 0 0 / 0.06);
      background: white;
      color: var(--node-clr);
      min-width: 130px;
      text-align: center;
    }
    .sys-topo__label {
      font-weight: 650;
      font-size: 13px;
      margin-top: 4px;
    }
    .sys-topo__sub {
      font-size: 11px;
      color: var(--faint);
      font-weight: 400;
    }
    .sys-topo__user {
      position: absolute;
      left: 50%;
      bottom: -16px;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 14px;
      border-radius: 20px;
      background: white;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      white-space: nowrap;
    }
    .sys-topo__user-sub {
      font-weight: 400;
      color: var(--faint);
      font-size: 11px;
    }

    /* ── Pillars ── */
    .pillars {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 28px 0 8px;
    }
    .pillar {
      padding: 20px 18px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid oklch(0 0 0 / 0.06);
      background: white;
    }
    .pillar__icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--pillar-bg);
      color: var(--pillar-clr);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .pillar__title {
      font-weight: 700;
      font-size: 15px;
      color: var(--pillar-clr);
      margin-bottom: 4px;
    }
    .pillar__desc {
      font-size: 13px;
      line-height: 1.55;
      color: var(--muted);
    }

    /* ── Extension surface blocks (Skills, Connections, Plugins) ── */
    .ext-surface-block {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      background: var(--card);
    }
    .ext-surface-block__head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .ext-surface-block__icon { flex-shrink: 0; }
    .ext-surface-block__title {
      font-size: 14px;
      font-weight: 700;
      color: var(--fg);
    }
    .ext-surface-block__tool {
      font-family: var(--font-mono);
      font-size: 10.5px;
      color: var(--muted);
      background: oklch(0 0 0 / 0.04);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }
    .ext-surface-block__desc {
      font-size: 12.5px;
      line-height: 1.55;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .ext-surface-block__desc code {
      font-family: var(--font-mono);
      font-size: 10.5px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .ext-surface-block--mb16 { margin-bottom: 16px; }
    .ext-surface-block--mb14 { margin-bottom: 14px; }
    .ext-surface-block__section-title {
      font-size: 13.5px;
      font-weight: 700;
      margin: 14px 0 8px;
    }
    .ext-surface-block__meta {
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.55;
      margin-bottom: 10px;
    }
    .ext-surface-block__meta code {
      font-family: var(--font-mono);
      font-size: 10.5px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 4px;
      border-radius: 3px;
    }

    /* ── Extension callout & detail surfaces ── */
    .ext-callout {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      background: oklch(0.97 0.015 270);
      border: 1px solid oklch(0.88 0.04 270);
      margin-bottom: 8px;
    }
    .ext-callout--mb12 { margin-bottom: 12px; }
    .ext-details { margin-top: 12px; }
    .ext-callout__icon {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: oklch(0.92 0.04 270);
      color: var(--violet);
    }
    .ext-callout__body {
      font-size: 13px;
      line-height: 1.55;
      color: var(--body);
    }
    .ext-surfaces {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
    }
    .ext-surface {
      padding: 14px 14px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid oklch(0 0 0 / 0.07);
      background: white;
    }
    .ext-surface__icon {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 7px;
      background: color-mix(in oklch, var(--sf-clr) 12%, white);
      color: var(--sf-clr);
      margin-bottom: 8px;
    }
    .ext-surface__label {
      font-weight: 650;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .ext-surface__desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    /* ── Capability grid ── */
    .cap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }
    .cap-group {
      padding: 12px 14px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid oklch(0 0 0 / 0.07);
      background: white;
    }
    .cap-group__head {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 650;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .cap-group__caps {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .cap-pill {
      font-size: 11px;
      font-weight: 500;
      font-family: var(--mono);
      padding: 3px 8px;
      border-radius: 4px;
      background: oklch(0.96 0 0);
      color: var(--body);
      white-space: nowrap;
    }
    .cap-pill--elevated {
      background: oklch(0.95 0.02 30);
      color: oklch(0.45 0.1 30);
    }
    /* ── Trust tiers ── */
    .ext-trust {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ext-trust__tier {
      display: grid;
      grid-template-columns: 130px auto 1fr;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid oklch(0 0 0 / 0.06);
      background: white;
    }
    @media (max-width: 640px) {
      .ext-trust__tier { grid-template-columns: 1fr; gap: 4px; }
    }
    .ext-trust__badge {
      font-size: 12px;
      font-weight: 650;
      padding: 3px 10px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .ext-trust__badge--host {
      background: oklch(0.93 0.04 160);
      color: oklch(0.35 0.1 160);
    }
    .ext-trust__badge--sandbox {
      background: oklch(0.93 0.04 80);
      color: oklch(0.40 0.08 80);
    }
    .ext-trust__sources {
      display: flex;
      gap: 4px;
    }
    .ext-trust__access {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* ── Boot rail timeline ── */
    .boot-rail {
      --rail-clr: oklch(0.82 0 0);
      position: relative;
      margin: 14px 0;
      padding-left: 36px;
    }
    .boot-phase:not(:last-child)::before {
      content: "";
      position: absolute;
      left: -23px;
      top: 28px;
      bottom: -1px;
      width: 1px;
      background: var(--rail-clr);
    }
    .boot-phase {
      position: relative;
      padding: 0 0 20px;
    }
    .boot-phase:last-child { padding-bottom: 0; }
    .boot-dot {
      position: absolute;
      left: -36px;
      top: 1px;
      width: 27px;
      height: 27px;
      border-radius: 50%;
      background: var(--card-bg);
      border: 1.5px solid var(--rail-clr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      z-index: 1;
    }
    .boot-phase--gate .boot-dot {
      background: oklch(0.95 0.04 160);
      border-color: oklch(0.72 0.1 160);
      color: oklch(0.38 0.08 150);
    }
    .boot-name {
      font-weight: 650;
      font-size: 13.5px;
      line-height: 27px; /* align with dot */
    }
    .boot-items {
      margin: 5px 0 0;
      padding: 0;
      list-style: none;
    }
    .boot-items li {
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.5;
      padding: 1.5px 0;
    }
    .boot-items li code {
      font-family: var(--font-mono);
      font-size: 11px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .boot-badge {
      display: inline-block;
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      background: oklch(0.94 0.02 80);
      color: oklch(0.45 0.06 80);
      vertical-align: 1px;
      margin-left: 2px;
    }

    /* ── Layers (stacked diagram) ── */
    .layers { display: flex; flex-direction: column; gap: 0; margin: 14px 0; }
    .layer {
      border: 1px solid var(--card-border);
      padding: 14px 20px;
      position: relative;
      text-align: center;
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }
    .layer:first-child { border-radius: var(--radius-sm) var(--radius-sm) 0 0; }
    .layer:last-child { border-radius: 0 0 var(--radius-sm) var(--radius-sm); }
    .layer + .layer { border-top: none; }
    .layer-name {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
    }
    .layer-desc {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .layer-badge {
      position: absolute;
      right: 14px;
      top: 12px;
      font-size: 10px;
    }

    /* ── Tool chips ── */
    /* ── Tool buckets ── */
    .tool-buckets { display: flex; flex-direction: column; gap: 10px; margin: 14px 0; }
    .tool-bucket {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .tool-bucket__head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-light);
    }
    .tool-bucket__icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 14px;
    }
    .tool-bucket__name {
      font-weight: 650;
      font-size: 13.5px;
    }
    .tool-bucket__count {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      color: var(--faint);
      margin-left: auto;
    }
    .tool-bucket__body { padding: 4px 0; }
    .tool-bucket__row {
      display: grid;
      grid-template-columns: 170px 1fr;
      padding: 5px 16px;
      font-size: 13px;
      gap: 8px;
    }
    .tool-bucket__row:hover { background: oklch(0 0 0 / 0.015); }
    .tool-bucket__tool {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
    }
    .tool-bucket__desc {
      color: var(--muted);
      line-height: 1.45;
    }
    .tool-bucket__desc code {
      font-family: var(--font-mono);
      font-size: 11px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .tool-bucket__note {
      padding: 5px 16px 8px;
      font-size: 12px;
      color: var(--faint);
      line-height: 1.45;
    }

    /* ── Rules & Conventions ── */
    .rc-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-bottom: 16px;
    }
    .rc-panel {
      border-left: 3px solid var(--rc-accent, var(--faint));
      padding: 16px 18px;
    }
    .rc-head {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    .rc-head__icon { flex-shrink: 0; }
    .rc-head__title {
      font-size: 13.5px;
      font-weight: 650;
      color: var(--fg);
      letter-spacing: 0.01em;
    }
    .rc-head__tool {
      font-family: var(--font-mono);
      font-size: 10.5px;
      color: var(--faint);
      margin-left: auto;
    }
    /* scope blocks (Rules) */
    .rc-scopes {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }
    .rc-scopes--h {
      flex-direction: row;
    }
    .rc-scopes--h .rc-scope { flex: 1; }
    .rc-scope {
      background: oklch(0 0 0 / 0.018);
      border: 1px solid oklch(0 0 0 / 0.06);
      border-radius: 6px;
      padding: 10px 12px;
    }
    .rc-scope__head {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      color: var(--muted);
    }
    .rc-scope__name {
      font-size: 12px;
      font-weight: 600;
      color: var(--fg);
    }
    .rc-scope__badge {
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--rc-accent, var(--muted));
      background: color-mix(in oklch, var(--rc-accent, var(--muted)) 8%, transparent);
      padding: 1px 7px;
      border-radius: 10px;
      letter-spacing: 0.03em;
    }
    .rc-scope__desc {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    /* area tiles (Conventions) */
    /* convention chips */
    .rc-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .rc-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--fg);
      background: color-mix(in oklch, var(--chip-clr, var(--muted)) 6%, transparent);
      border: 1px solid color-mix(in oklch, var(--chip-clr, var(--muted)) 14%, transparent);
      border-radius: 7px;
      padding: 5px 10px;
    }
    .rc-chip svg { color: var(--chip-clr); flex-shrink: 0; }
    .rc-chip__count {
      font-size: 10px;
      font-weight: 700;
      color: var(--chip-clr);
      background: color-mix(in oklch, var(--chip-clr, var(--muted)) 12%, transparent);
      padding: 1px 5px;
      border-radius: 6px;
      margin-left: 1px;
    }
    /* description line below header */
    .rc-desc {
      font-size: 12px;
      color: var(--faint);
      line-height: 1.5;
      margin-bottom: 12px;
    }
    .rc-desc code {
      font-family: var(--font-mono);
      font-size: 10.5px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 4px;
      border-radius: 3px;
    }
    @media (max-width: 700px) {
      .rc-scopes--h { flex-direction: column; }
    }

    /* ── Shared tool-table (used in wrapping, auth, testing) ── */
    .tool-table-wrap {
      margin: 10px 0 16px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow), var(--glass-highlight), var(--glass-inner);
      backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      -webkit-backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      overflow: hidden;
    }
    .tool-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .tool-table th {
      font-family: var(--font-mono);
      font-size: 9.5px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--faint);
      text-align: left;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--green-lighter);
    }
    .tool-table td {
      padding: 7px 14px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: baseline;
    }
    .tool-table tr:last-child td { border-bottom: none; }
    .tool-table tr:hover td { background: oklch(0 0 0 / 0.015); }
    .tool-table .t-name {
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
      color: var(--green);
      white-space: nowrap;
    }
    .tool-table .t-desc {
      color: var(--muted);
      line-height: 1.45;
    }
    .ext-table td { vertical-align: middle; }
    .ext-table th:first-child,
    .ext-table .ext-accent {
      text-align: center;
      padding-left: 10px;
      padding-right: 6px;
      width: 38px;
    }
    .ext-table .ext-accent svg { display: block; margin: 0 auto; }
    .ext-table td code {
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .ext-table .t-name { white-space: nowrap; min-width: 100px; }

    /* ── Timeline (numbered left-edge dots) ── */
    .timeline { position: relative; margin: 14px 0; padding-left: 28px; }
    .tl-step:not(:last-child)::before {
      content: '';
      position: absolute;
      left: -19px;
      top: 22px;
      bottom: -1px;
      width: 2px;
      background: var(--border);
    }
    .tl-step { position: relative; padding: 0 0 18px; }
    .tl-step:last-child { padding-bottom: 0; }
    .tl-dot {
      position: absolute;
      left: -28px;
      top: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 700;
      z-index: 1;
    }
    .tl-label { font-weight: 600; font-size: 13.5px; line-height: 1.3; }
    .tl-detail { font-size: 12.5px; color: var(--muted); line-height: 1.55; margin-top: 2px; }

    /* ── Snapshot tiles ── */
    .snap-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }
    .snap-tile {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      box-shadow: var(--shadow), var(--glass-highlight);
      backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      -webkit-backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      text-align: center;
    }
    .snap-tile svg { margin-bottom: 6px; }
    .snap-name {
      font-weight: 600;
      font-size: 12px;
      line-height: 1.2;
    }
    .snap-desc {
      font-size: 11px;
      color: var(--faint);
      line-height: 1.4;
      margin-top: 3px;
    }

    /* ── Spec rows (label-value horizontal pairs) ── */
    .spec-list { margin: 10px 0; }
    .spec-list--flush { margin: 0; }
    .spec-list--compact {
      margin: 0;
      font-size: 12px;
    }
    .spec-list--wide-keys { --spec-key-w: 140px; }
    .spec-row {
      display: flex;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-light);
      align-items: baseline;
    }
    .spec-row:last-child { border-bottom: none; }
    .spec-key {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--faint);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      min-width: var(--spec-key-w, 90px);
      flex-shrink: 0;
    }
    .spec-val {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    .spec-val code {
      font-family: var(--font-mono);
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
      color: var(--fg);
    }

    /* ── Kbd grid ── */
    .kbd-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 6px 16px;
      margin: 10px 0;
    }
    .kbd-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 0;
    }
    .kbd-row kbd {
      font-family: var(--font-mono);
      font-size: 10.5px;
      font-weight: 500;
      background: var(--card-bg);
      border: 1px solid oklch(0 0 0 / 0.12);
      border-bottom-width: 2px;
      border-radius: 4px;
      padding: 2px 7px;
      color: var(--fg);
      white-space: nowrap;
      box-shadow: 0 1px 1px oklch(0 0 0 / 0.04);
    }
    .kbd-desc {
      font-size: 12px;
      color: var(--muted);
    }

    /* ── Defense boundary list ── */
    .defense-list { margin: 0; }
    .defense-row {
      display: flex;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border-light);
      align-items: flex-start;
    }
    .defense-row:last-child { border-bottom: none; }
    .defense-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .defense-body { flex: 1; min-width: 0; }
    .defense-name {
      font-weight: 600;
      font-size: 13.5px;
      line-height: 1.2;
      margin-bottom: 3px;
    }
    .defense-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.55;
    }
    .defense-desc code {
      font-family: var(--font-mono);
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
      color: var(--fg);
    }

    /* ── Prefix anatomy diagram ── */
    .prefix-anatomy {
      border: 1px solid var(--border-light);
      border-radius: 12px;
      overflow: hidden;
    }
    .prefix-zone { padding: 16px 20px; }
    .prefix-zone--frozen { background: oklch(0.98 0.005 250); }
    .prefix-zone--history { background: oklch(0.98 0.003 0); }
    .prefix-zone--fresh { background: oklch(0.975 0.005 140); }
    .prefix-zone__bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .prefix-zone__label {
      font-weight: 700;
      font-size: 13.5px;
      letter-spacing: 0.01em;
    }
    .prefix-zone__badge {
      font-size: 11px;
      font-family: var(--font-mono);
      padding: 2px 8px;
      border-radius: 6px;
      background: oklch(0.92 0.02 250);
      color: var(--muted);
    }
    .prefix-zone__slots {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .prefix-slot {
      font-size: 12.5px;
      color: var(--muted);
      padding: 5px 12px;
      border-radius: 6px;
      background: oklch(1 0 0 / 0.65);
      border: 1px solid oklch(0 0 0 / 0.06);
    }
    .prefix-slot__tag {
      font-weight: 600;
      font-family: var(--font-mono);
      font-size: 11.5px;
      color: var(--slot-clr, var(--fg));
      margin-right: 4px;
    }
    .prefix-zone__note {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .prefix-zone__note code {
      font-family: var(--font-mono);
      font-size: 11px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .prefix-tail-slices {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .prefix-tail-slice {
      display: grid;
      grid-template-columns: 18px 110px 1fr;
      gap: 0 6px;
      font-size: 12.5px;
      line-height: 1.5;
      align-items: first baseline;
    }
    .prefix-tail-slice__icon {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      top: 2px;
    }
    .prefix-tail-slice__name {
      font-weight: 600;
      white-space: nowrap;
      font-size: 12.5px;
    }
    .prefix-tail-slice__desc {
      color: var(--muted);
      font-size: 12.5px;
    }
    .prefix-tail-slice__desc code {
      font-family: var(--font-mono);
      font-size: 11px;
      background: oklch(0 0 0 / 0.04);
      padding: 1px 4px;
      border-radius: 3px;
    }
    .prefix-tail-slice--dim {
      opacity: 0.55;
    }
    .prefix-tail-divider {
      border: none;
      border-top: 1px dashed oklch(0 0 0 / 0.1);
      margin: 4px 0;
    }
    .prefix-zone-divider {
      border: none;
      border-top: 1px solid oklch(0 0 0 / 0.08);
      margin: 0;
    }

    /* ── Invariant checklist ── */
    .invariant-list { margin: 8px 0 0; }
    .invariant-row {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light);
      align-items: flex-start;
    }
    .invariant-row:last-child { border-bottom: none; }
    .invariant-check {
      flex-shrink: 0;
      margin-top: 2px;
    }
    .invariant-body { flex: 1; min-width: 0; }
    .invariant-name {
      font-weight: 600;
      font-size: 13.5px;
      display: block;
      margin-bottom: 3px;
    }
    .invariant-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.55;
      display: block;
    }
    .invariant-desc code {
      font-family: var(--font-mono);
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
      color: var(--fg);
    }

    /* ── Inline list ── */
    .ilist { list-style: none; padding: 0; margin: 6px 0 0; }
    .ilist li {
      position: relative;
      padding: 3px 0 3px 16px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.55;
    }
    .ilist li::before {
      content: '›';
      position: absolute;
      left: 0;
      color: var(--green);
      font-weight: 700;
    }
    .ilist code {
      font-family: var(--font-mono);
      font-size: 11.5px;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
      color: var(--fg);
    }

    /* ── Badges ── */
    .badge {
      display: inline-block;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      padding: 2px 8px;
      border-radius: 4px;
      line-height: 1.6;
      white-space: nowrap;
    }
    .b-green  { background: var(--green-light); color: var(--green); }
    .b-blue   { background: var(--blue-light); color: var(--blue); }
    .b-amber  { background: var(--amber-light); color: var(--amber); }
    .b-rose   { background: var(--rose-light); color: var(--rose); }
    .b-violet { background: var(--violet-light); color: var(--violet); }
    .b-orange { background: var(--orange-light); color: var(--orange); }
    .b-cyan   { background: var(--cyan-light); color: var(--cyan); }
    .b-pink   { background: var(--pink-light); color: var(--pink); }

    /* ── Details / collapsible ── */
    details {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
      -webkit-backdrop-filter: blur(3px) saturate(1.6) brightness(1.04);
    }
    details summary {
      padding: 14px 18px;
      font-weight: 600;
      font-size: 13.5px;
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--fg);
    }
    details summary::before {
      content: '▸';
      color: var(--green);
      font-size: 12px;
      transition: transform 0.15s;
    }
    details[open] summary::before { transform: rotate(90deg); }
    details summary::-webkit-details-marker { display: none; }
    details .inner { padding: 0 18px 14px; }

    /* ── Inline elements ── */
    code {
      font-family: var(--font-mono);
      font-size: 0.88em;
      background: oklch(0 0 0 / 0.05);
      padding: 1px 5px;
      border-radius: 4px;
    }
    a { color: var(--green); }
    a:hover { color: var(--green-strong); }

    /* ── Credits ── */
    .credits {
      margin-top: 48px;
      padding-bottom: 8px;
    }
    .credits-rule {
      border: none;
      border-top: 1px solid var(--border-light);
      margin-bottom: 20px;
    }
    .credits-heading {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--faint);
      margin-bottom: 16px;
    }
    .credits-list {
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .credits-entry {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px;
      align-items: baseline;
    }
    .credits-entry dt {
      font-size: 12px;
      font-weight: 600;
      font-family: var(--mono);
    }
    .credits-entry dt a {
      color: var(--green);
      text-decoration: none;
    }
    .credits-entry dt a:hover { text-decoration: underline; }
    .credits-entry dd {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .credits-entry dd a {
      color: var(--fg);
      font-weight: 500;
      text-decoration: none;
    }
    .credits-entry dd a:hover { text-decoration: underline; }

    /* ── Footer (matches landing) ── */
    footer {
      padding: 48px 0;
      border-top: 1px solid oklch(0 0 0 / 0.06);
      margin-top: 24px;
    }
    .footer-pi {
      font-family: var(--font-display);
      font-size: 32px;
      color: var(--green);
      opacity: 0.15;
      display: block;
      margin-bottom: 12px;
    }
    footer p {
      font-size: 13px;
      color: var(--faint);
      line-height: 1.7;
    }
    .footer-note { margin-top: 8px; }
    footer a { color: var(--green); text-decoration: none; }
    footer a:hover { text-decoration: underline; }

    /* ── Animations ── */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .hero-eyebrow { animation: fadeUp 0.6s ease both; }
    .hero h1 { animation: fadeUp 0.6s ease 0.06s both; }
    .hero-sub { animation: fadeUp 0.6s ease 0.12s both; }
    .hero-version { animation: fadeUp 0.6s ease 0.18s both; }
    .reveal {
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .reveal.visible { opacity: 1; transform: translateY(0); }
    @media (prefers-reduced-motion: reduce) {
      .hero-eyebrow, .hero h1, .hero-sub, .hero-version { animation: none !important; }
      .reveal { opacity: 1 !important; transform: none !important; transition: none !important; }
    }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      .card { padding: 16px; }
      .tool-table { font-size: 12px; }
      .tool-table th, .tool-table td { padding: 6px 10px; }
    }
    @media (max-width: 480px) {
      nav { flex-wrap: wrap; gap: 8px; }
      .nav-mark { flex: 1 1 auto; min-width: 0; }
      .exp-badge { font-size: 9px; padding: 2px 7px; margin-left: 6px; }
      .nav-links { gap: 14px; flex-wrap: wrap; }
      .tool-table .t-name { font-size: 11px; }
      .tool-table .t-desc { font-size: 11.5px; }
    }
  </style>
</head>
<body>

<div class="page">

  <!-- ── Nav (matches landing) ── -->
  <nav>
    <a href="/" class="nav-mark"><span class="nav-mark__logo">π</span> <span class="nav-mark__text">Pi for Excel</span> <span class="exp-badge">Experimental</span></a>
    <div class="nav-links">
      <a href="/#install">Install</a>
      <a href="/#connect">Connect</a>
      <a href="/architecture" class="active">Architecture</a>
      <a href="https://github.com/tmustier/pi-for-excel" class="gh-link" target="_blank" rel="noopener">
        <svg viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
        GitHub
      </a>
    </div>
  </nav>


  <!-- ── Hero ── -->
  <div class="hero">
    <p class="hero-eyebrow">Pi for Excel</p>
    <h1>Architecture</h1>
    <p class="hero-sub">
      A codebase snapshot at v0.9.0-pre — covering tools and extensions, interface, model pipeline, session lifecycle, safety, and testing.
    </p>
    <p class="hero-version">Generated by <a href="https://pi.dev" target="_blank" rel="noopener">Pi</a> using <a href="https://github.com/nicobailon/visual-explainer" target="_blank" rel="noopener">nicobailon/visual-explainer</a> <span class="hero-sep">·</span> Feb 2026 <span class="hero-sep">·</span> <a href="https://github.com/tmustier/pi-for-excel/commit/a089f86" target="_blank" rel="noopener">a089f86</a></p>
  </div>


  <!-- ── Content wrap with TOC ── -->
  <div class="content-wrap">

    <nav class="toc" id="toc">
      <div class="toc-title">Contents</div>
      <a href="#s0">Overview</a>
      <a href="#s1">Capabilities</a>
        <a href="#s1-tools" class="toc-sub">Default Tools</a>
        <a href="#s1-ext" class="toc-sub">Extensions</a>
      <a href="#s2">Interface</a>
        <a href="#s2-ui" class="toc-sub">User Interface</a>
        <a href="#s2-agent" class="toc-sub">Agent Interface</a>
        <a href="#s2-rules" class="toc-sub">Rules &amp; Conventions</a>
      <a href="#s3">Model Layer</a>
        <a href="#s3-llm" class="toc-sub">LLM Pipeline</a>
        <a href="#s3-cache" class="toc-sub">Prompt Caching</a>
      <a href="#s4">Lifecycle</a>
        <a href="#s4-session" class="toc-sub">Session Runtime</a>
        <a href="#s4-boot" class="toc-sub">Boot Sequence</a>
      <a href="#s5">Safety &amp; Recovery</a>
      <a href="#s6">Testing</a>

    </nav>

    <div class="main">


<!-- ═══════════════ S0: OVERVIEW ═══════════════ -->
<div id="s0" class="sec-head reveal">Overview</div>

<p class="card-desc reveal" style="margin-bottom:6px;font-size:15px;line-height:1.65">
  Pi for Excel is an AI agent that lives inside Excel's taskpane. It reads, writes, formats, and analyzes spreadsheets through natural conversation — backed by any major LLM provider. 24&nbsp;built-in tools, a sandboxed extension runtime, and bridges to Python, tmux, and MCP servers make it a general-purpose automation surface for spreadsheets.
</p>

<!-- System topology diagram -->
<div class="sys-topo reveal">
  <div class="sys-topo__center">
    <div class="sys-topo__hub">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/></svg>
      <span>Agent</span>
    </div>
  </div>
  <div class="sys-topo__ring">
    <div class="sys-topo__spoke sys-topo__spoke--top">
      <div class="sys-topo__node" style="--node-clr:var(--green)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
        <span class="sys-topo__label">5 LLM Providers</span>
        <span class="sys-topo__sub">OAuth · stream proxy · prefix caching</span>
      </div>
    </div>
    <div class="sys-topo__spoke sys-topo__spoke--left">
      <div class="sys-topo__node" style="--node-clr:var(--blue)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="3" y2="21"/></svg>
        <span class="sys-topo__label">Excel</span>
        <span class="sys-topo__sub">Office.js · WorkbookCoordinator</span>
      </div>
    </div>
    <div class="sys-topo__spoke sys-topo__spoke--right">
      <div class="sys-topo__node" style="--node-clr:var(--violet)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>
        <span class="sys-topo__label">Extensions</span>
        <span class="sys-topo__sub">Sandboxed · 18 capabilities</span>
      </div>
    </div>
    <div class="sys-topo__spoke sys-topo__spoke--bottom">
      <div class="sys-topo__node" style="--node-clr:var(--amber)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>
        <span class="sys-topo__label">Bridges</span>
        <span class="sys-topo__sub">Python · tmux · MCP · web</span>
      </div>
    </div>
  </div>
  <div class="sys-topo__user">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    <span>User</span>
    <span class="sys-topo__user-sub">Sidebar taskpane · 350px</span>
  </div>
</div>

<!-- 3 pillars -->
<div class="pillars reveal">
  <div class="pillar" style="--pillar-clr:var(--green);--pillar-bg:var(--green-light)">
    <div class="pillar__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg>
    </div>
    <div class="pillar__title">Capable</div>
    <div class="pillar__desc">24 tools in 5 categories — from cell reads to Python scripts, terminal sessions, and MCP servers. Plus 28+ slash commands.</div>
  </div>
  <div class="pillar" style="--pillar-clr:var(--violet);--pillar-bg:var(--violet-light)">
    <div class="pillar__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>
    </div>
    <div class="pillar__title">Extensible</div>
    <div class="pillar__desc">18-capability extension runtime with trust tiers. Self-authoring loop — Pi can build and install extensions from chat.</div>
  </div>
  <div class="pillar" style="--pillar-clr:var(--rose);--pillar-bg:var(--rose-light)">
    <div class="pillar__icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>
    </div>
    <div class="pillar__title">Safe</div>
    <div class="pillar__desc">Every mutation snapshotted. 6 defense boundaries — SSRF, markdown, bridge, sandbox, HTML, secret redaction. Undo the undo.</div>
  </div>
</div>

<p class="card-desc reveal" style="margin-top:8px;font-size:13px;color:var(--faint)">
  This page covers <strong style="color:var(--muted)">what Pi can do</strong> (Capabilities, Interface), then <strong style="color:var(--muted)">how it works</strong> under the hood (Model Layer, Lifecycle, Safety &amp; Recovery, Testing).
</p>


<!-- ═══════════════ S1: CAPABILITIES ═══════════════ -->
<div id="s1" class="sec-head reveal">Capabilities</div>

<h3 id="s1-tools" class="reveal">Default Tools</h3>
<p class="card-desc reveal" style="margin-bottom:14px">
  24 tools in 5 categories — from cell reads to terminal sessions and MCP servers.
</p>
<div class="tool-buckets reveal">

  <!-- Read & Inspect -->
  <div class="tool-bucket">
    <div class="tool-bucket__head">
      <div class="tool-bucket__icon" style="background:oklch(0.94 0.04 160);color:var(--green)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></div>
      <span class="tool-bucket__name">Read &amp; Inspect</span>
      <span class="tool-bucket__count">5 tools</span>
    </div>
    <div class="tool-bucket__body">
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--green)">get_workbook_overview</span><span class="tool-bucket__desc">Blueprint: sheets, tables, named ranges, objects + per-sheet detail mode</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--green)">read_range</span><span class="tool-bucket__desc">3 modes: compact / csv / detailed. Comments in detailed, format humanization</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--green)">search_workbook</span><span class="tool-bucket__desc">Text / formula / regex search, pagination, context rows</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--green)">trace_dependencies</span><span class="tool-bucket__desc">Precedent / dependent tracing, depth 5, 50K cell scan</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--green)">explain_formula</span><span class="tool-bucket__desc">Plain-language explanation, load direct references</span></div>
    </div>
  </div>

  <!-- Write & Transform -->
  <div class="tool-bucket">
    <div class="tool-bucket__head">
      <div class="tool-bucket__icon" style="background:oklch(0.93 0.04 250);color:var(--blue)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg></div>
      <span class="tool-bucket__name">Write &amp; Transform</span>
      <span class="tool-bucket__count">3 tools</span>
    </div>
    <div class="tool-bucket__body">
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--blue)">write_cells</span><span class="tool-bucket__desc">Overwrite protection, formula validation, auto-verify, recovery snapshot</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--blue)">fill_formula</span><span class="tool-bucket__desc">AutoFill single formula across range, error detection</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--blue)">modify_structure</span><span class="tool-bucket__desc">10 actions: insert / delete rows / cols / sheets, rename, move</span></div>
    </div>
  </div>

  <!-- Format & Annotate -->
  <div class="tool-bucket">
    <div class="tool-bucket__head">
      <div class="tool-bucket__icon" style="background:oklch(0.94 0.04 80);color:var(--amber)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10-1.5 4-3 4h-1.6c-.5 0-.8.3-.8.8 0 .2.1.5.2.6.2.3.3.6.3 1 0 1.1-.9 1.6-2.1 1.6"/><circle cx="7.5" cy="11.5" r="1.5"/><circle cx="12" cy="7.5" r="1.5"/><circle cx="16.5" cy="11.5" r="1.5"/></svg></div>
      <span class="tool-bucket__name">Format &amp; Annotate</span>
      <span class="tool-bucket__count">4 tools</span>
    </div>
    <div class="tool-bucket__body">
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--amber)">format_cells</span><span class="tool-bucket__desc">Named styles, conventions, multi-range, borders, merge</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--amber)">conditional_format</span><span class="tool-bucket__desc">8 rule types: cell_value, formula, text, top_bottom, preset, data_bar, color_scale, icon_set</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--amber)">view_settings</span><span class="tool-bucket__desc">15 actions: gridlines, freeze, tab color, hide / show sheets</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--amber)">comments</span><span class="tool-bucket__desc">7 actions: read / add / update / reply / delete / resolve / reopen</span></div>
    </div>
  </div>

  <!-- Session & Config -->
  <div class="tool-bucket">
    <div class="tool-bucket__head">
      <div class="tool-bucket__icon" style="background:oklch(0.94 0 0);color:var(--muted)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <span class="tool-bucket__name">Session &amp; Config</span>
      <span class="tool-bucket__count">4 tools</span>
    </div>
    <div class="tool-bucket__body">
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--muted)">workbook_history</span><span class="tool-bucket__desc">List / restore / delete recovery snapshots</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--muted)">instructions</span><span class="tool-bucket__desc">User / workbook scope rules management</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--muted)">skills</span><span class="tool-bucket__desc">List / read skills, session-scoped read cache</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--muted)">conventions</span><span class="tool-bucket__desc">6 built-in formatting presets, custom presets</span></div>
    </div>
  </div>

  <!-- Bridges & Integrations -->
  <div class="tool-bucket">
    <div class="tool-bucket__head">
      <div class="tool-bucket__icon" style="background:oklch(0.93 0.04 300);color:var(--violet)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg></div>
      <span class="tool-bucket__name">Bridges &amp; Integrations</span>
      <span class="tool-bucket__count">8 tools</span>
    </div>
    <div class="tool-bucket__body">
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">execute_office_js</span><span class="tool-bucket__desc">Direct Office.js eval via blob URL module — <code>Excel.run()</code> banned (context auto-provided). 20K code, 8K result. Requires user approval.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">python_run</span><span class="tool-bucket__desc">Execute Python scripts. Native bridge preferred → Pyodide fallback.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">python_transform_range</span><span class="tool-bucket__desc">Read range → Python transform → write back. Same bridge stack.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">libreoffice_convert</span><span class="tool-bucket__desc">File format conversion. Bridge-only (no Pyodide fallback).</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">tmux</span><span class="tool-bucket__desc">Full terminal sessions via local bridge (port 3341). 6 actions with dynamic timeout — run shell commands, interactive REPLs, background processes.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">web_search</span><span class="tool-bucket__desc">5 providers (Jina zero-config fallback, Serper, Tavily, Brave, Firecrawl). Domain rate limiting.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">fetch_page</span><span class="tool-bucket__desc">DOMParser → markdown. 12K default / 50K max result.</span></div>
      <div class="tool-bucket__row"><span class="tool-bucket__tool" style="color:var(--violet)">mcp</span><span class="tool-bucket__desc">Full JSON-RPC 2.0 gateway: initialize → tools/list → tools/call. Multi-server discovery, tool caching, proxy-routed.</span></div>
    </div>
  </div>

</div>


<details class="reveal" style="margin-top:12px">
  <summary>Tool Wrapping Pipeline</summary>
  <div class="inner">
    <p class="card-desc" style="margin-bottom:10px">
      Every tool passes through 3 wrapping layers before reaching the agent. Order matters — outermost wrapper executes first.
    </p>
    <div class="layers">
      <div class="layer" style="background:var(--violet-light)">
        <div class="layer-name" style="color:var(--violet)">Layer 3: Output Truncation</div>
        <div class="layer-desc">2K lines / 50KB. Head strategy (data) or tail strategy (logs). Full output saved to workspace files.</div>
        <span class="badge b-violet layer-badge">outermost</span>
      </div>
      <div class="layer" style="background:var(--blue-light)">
        <div class="layer-name" style="color:var(--blue)">Layer 2: Connection Preflight</div>
        <div class="layer-desc">Pre-check connection status. Post-catch auth failures (401/403). Secret redaction in errors. Fuzzy connection matching.</div>
      </div>
      <div class="layer" style="background:var(--green-light)">
        <div class="layer-name" style="color:var(--green)">Layer 1: Workbook Coordinator</div>
        <div class="layer-desc">read → runRead, mutate → runWrite (FIFO queue). Execution mode gating (yolo/safe). Mutation observer dispatch.</div>
        <span class="badge b-green layer-badge">innermost</span>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Full Pipeline</h3>
      <div class="card-desc">
        <code>createAllTools()</code> → <code>applyExperimentalToolGates()</code> → <code>createToolsForIntegrations()</code> → <code>extensionManager.getRegisteredTools()</code> → <code>normalizeRuntimeTools()</code> → <code>withWorkbookCoordinator()</code> → <code>withConnectionPreflight()</code> → <code>applyToolOutputTruncation()</code>
      </div>
      <ul class="ilist" style="margin-top:8px">
        <li>Fingerprint comparison (FNV-1a hash of tool schemas) decides whether to call <code>agent.setTools()</code></li>
        <li>Extension tool revision counter (monotonic) also triggers refresh when extensions add/remove tools</li>
        <li>Static tool ordering preserved for prompt cache stability</li>
      </ul>
    </div>
  </div>
</details>



<h3 id="s1-ext" class="reveal" style="margin-top:22px">Extensions</h3>
<p class="card-desc reveal" style="margin-bottom:14px">
  Three extension surfaces — <strong>Connections</strong>, <strong>Plugins</strong>, and <strong>Skills</strong> — let users and the agent expand Pi's capabilities at runtime. Each has a dedicated tab in <code>/extensions</code>.
</p>

<!-- ── Skills ── -->
<div class="ext-surface-block ext-surface-block--mb16 reveal">
  <div class="ext-surface-block__head">
    <svg class="ext-surface-block__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
    <span class="ext-surface-block__title">Skills</span>
    <code class="ext-surface-block__tool">skills</code>
  </div>
  <p class="ext-surface-block__desc">
    Markdown documents (<code>SKILL.md</code>) that inject task-specific workflows into the conversation on demand. The agent calls <code>skills → read</code> when a task matches; the full document becomes part of the context.
  </p>
  <div class="rc-chips" style="margin-bottom:8px">
    <span class="rc-chip" style="--chip-clr:var(--green)">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 7h10"/><path d="M7 12h10"/><path d="M7 17h10"/></svg>
      4 bundled
    </span>
    <span class="rc-chip" style="--chip-clr:var(--blue)">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>
      workspace-discovered
    </span>
    <span class="rc-chip" style="--chip-clr:var(--violet)">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m8 12 3 3 5-6"/></svg>
      toggle per-skill
    </span>
  </div>
  <div class="spec-list spec-list--compact">
    <div class="spec-row"><div class="spec-key">Bundled</div><div class="spec-val">python-bridge · tmux-bridge · web-search · mcp-gateway — loaded via Vite <code>import.meta.glob</code></div></div>
    <div class="spec-row"><div class="spec-key">External</div><div class="spec-val"><code>skills/external/&lt;name&gt;/SKILL.md</code> — managed installs via the <code>skills</code> tool or workspace discovery</div></div>
    <div class="spec-row"><div class="spec-key">Prompt</div><div class="spec-val">Catalog listed in system prompt under <code>## Available Agent Skills</code>; body injected on read. Session-scoped read cache avoids duplicates.</div></div>
    <div class="spec-row"><div class="spec-key">Activation</div><div class="spec-val">Per-skill enable/disable in <code>/extensions → Skills</code>. Stored in SettingsStore (<code>skills.activation.v1</code>).</div></div>
  </div>
</div>

<!-- ── Connections ── -->
<div class="ext-surface-block ext-surface-block--mb16 reveal">
  <div class="ext-surface-block__head">
    <svg class="ext-surface-block__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>
    <span class="ext-surface-block__title">Connections</span>
  </div>
  <p class="ext-surface-block__desc">
    Credential requirements declared by plugins or built-in integrations. Each connection stores secrets,
    surfaces auth state, and gates tool access — if a tool's connection isn't configured, the tool is
    withheld from the model. Managed in <code>/extensions → Connections</code>.
  </p>
  <div class="spec-list spec-list--compact spec-list--wide-keys">
    <div class="spec-row"><div class="spec-key">External tools</div><div class="spec-val">Master toggle for web search, fetch, and other network-dependent tools</div></div>
    <div class="spec-row"><div class="spec-key">Web search</div><div class="spec-val">Jina (default, no key) · Serper · Tavily · Brave Search — provider-specific API key fields</div></div>
    <div class="spec-row"><div class="spec-key">Plugin connections</div><div class="spec-val">Owner-scoped (<code>{ownerId}.{connId}</code>). Auto-rendered setup UI from plugin declarations.</div></div>
  </div>
</div>

<!-- ── Plugins ── -->
<div class="ext-surface-block ext-surface-block--mb14 reveal">
  <div class="ext-surface-block__head">
    <svg class="ext-surface-block__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>
    <span class="ext-surface-block__title">Plugins</span>
    <code class="ext-surface-block__tool">extensions_manager</code>
  </div>
  <p class="ext-surface-block__desc">
    Runtime code modules that register tools, commands, sidebar widgets, overlays, and connections. Users install them from <code>/extensions</code>; the agent can also create and install them from chat.
  </p>

  <!-- Self-authoring callout -->
  <div class="ext-callout ext-callout--mb12">
    <div class="ext-callout__icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg></div>
    <div class="ext-callout__body">
      <strong>Pi can extend itself</strong> — design, generate, install, reload, and iterate on plugins without leaving the conversation. The <code>extensions_manager</code> tool handles the full lifecycle: list → install → enable → reload → uninstall.
    </div>
  </div>

  <h4 class="ext-surface-block__section-title">What Plugins Register</h4>

  <div class="ext-surfaces">
    <div class="ext-surface">
      <div class="ext-surface__icon" style="--sf-clr:var(--blue)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76Z"/></svg></div>
      <div class="ext-surface__label">Tools</div>
      <div class="ext-surface__desc">Agent-callable tools with TypeBox / JSON schema params. Name-conflict guard against core tools.</div>
    </div>
    <div class="ext-surface">
      <div class="ext-surface__icon" style="--sf-clr:var(--green)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg></div>
      <div class="ext-surface__label">Commands</div>
      <div class="ext-surface__desc">Slash commands with <code>busyAllowed</code> control. Appear in command menu.</div>
    </div>
    <div class="ext-surface">
      <div class="ext-surface__icon" style="--sf-clr:var(--violet)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg></div>
      <div class="ext-surface__label">Widgets</div>
      <div class="ext-surface__desc">Sidebar panels via Widget API v2: <code>upsert</code> / <code>remove</code> / <code>clear</code>. Placement, ordering, collapsible, size bounds.</div>
    </div>
    <div class="ext-surface">
      <div class="ext-surface__icon" style="--sf-clr:var(--amber)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg></div>
      <div class="ext-surface__label">Connections</div>
      <div class="ext-surface__desc">Declare credential requirements, store secrets, surface auth state. Auto-rendered in <code>/tools</code> overlay.</div>
    </div>
    <div class="ext-surface">
      <div class="ext-surface__icon" style="--sf-clr:var(--rose)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/></svg></div>
      <div class="ext-surface__label">Overlays</div>
      <div class="ext-surface__desc">Full-screen modal via <code>overlay.show(el)</code>. Single overlay per plugin at a time.</div>
    </div>
  </div>

  <h4 class="ext-surface-block__section-title">18 Capability Gates</h4>
  <p class="ext-surface-block__meta">
    Every API call passes through <code>assertCapability()</code>. Sandbox iframe bridges all 18 surfaces via postMessage with CSP + TypeBox schema reconstruction.
  </p>

  <div class="cap-grid">
    <div class="cap-group">
      <div class="cap-group__head">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/></svg>
        Agent
      </div>
      <div class="cap-group__caps">
        <span class="cap-pill">agent.read</span>
        <span class="cap-pill">agent.events.read</span>
        <span class="cap-pill cap-pill--elevated">agent.context.write</span>
        <span class="cap-pill cap-pill--elevated">agent.steer</span>
        <span class="cap-pill cap-pill--elevated">agent.followup</span>
      </div>
    </div>
    <div class="cap-group">
      <div class="cap-group__head">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        UI &amp; Output
      </div>
      <div class="cap-group__caps">
        <span class="cap-pill">ui.overlay</span>
        <span class="cap-pill">ui.widget</span>
        <span class="cap-pill">ui.toast</span>
        <span class="cap-pill">clipboard.write</span>
        <span class="cap-pill">download.file</span>
      </div>
    </div>
    <div class="cap-group">
      <div class="cap-group__head">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z"/></svg>
        Integration
      </div>
      <div class="cap-group__caps">
        <span class="cap-pill cap-pill--elevated">tools.register</span>
        <span class="cap-pill">commands.register</span>
        <span class="cap-pill cap-pill--elevated">llm.complete</span>
        <span class="cap-pill cap-pill--elevated">http.fetch</span>
        <span class="cap-pill">storage.readwrite</span>
        <span class="cap-pill cap-pill--elevated">connections.readwrite</span>
        <span class="cap-pill">skills.read</span>
        <span class="cap-pill cap-pill--elevated">skills.write</span>
      </div>
    </div>
  </div>

  <h4 class="ext-surface-block__section-title">Trust Tiers &amp; Runtime</h4>

  <div class="ext-trust">
    <div class="ext-trust__tier">
      <div class="ext-trust__badge ext-trust__badge--host">Host runtime</div>
      <div class="ext-trust__sources">
        <span class="badge b-green">builtin</span>
        <span class="badge b-blue">local module</span>
      </div>
      <div class="ext-trust__access">Full access — minus steer / follow-up / context-write / skills-write</div>
    </div>
    <div class="ext-trust__tier">
      <div class="ext-trust__badge ext-trust__badge--sandbox">Sandbox iframe</div>
      <div class="ext-trust__sources">
        <span class="badge b-amber">inline code</span>
        <span class="badge b-rose">remote URL</span>
      </div>
      <div class="ext-trust__access">Restricted — no tools / agent / llm / http / connections by default. Capability toggles in <code>/extensions</code>.</div>
    </div>
  </div>

  <details class="ext-details">
    <summary>Lifecycle &amp; Activation Bridge</summary>
    <div class="inner">
      <div class="spec-list spec-list--flush">
        <div class="spec-row"><div class="spec-key">Load</div><div class="spec-val">v2 doc from SettingsStore (v1 auto-migrated). Source: module specifier or inline code blob URL.</div></div>
        <div class="spec-row"><div class="spec-key">Activate</div><div class="spec-val">Resolve runtime (host / sandbox). Build activation bridge. Register tools &amp; commands with conflict check.</div></div>
        <div class="spec-row"><div class="spec-key">Deactivate</div><div class="spec-val">Reverse order: handle → widgets → events → commands → tools → connections → blob URLs.</div></div>
      </div>
      <hr style="border:none;border-top:1px dashed oklch(0 0 0 / 0.08);margin:10px 0">
      <div class="spec-list spec-list--flush">
        <div class="spec-row"><div class="spec-key">LLM bridge</div><div class="spec-val">Active agent's model + API key. Per-plugin side session ID for isolated cache telemetry.</div></div>
        <div class="spec-row"><div class="spec-key">HTTP bridge</div><div class="spec-val">URL validation + blocked hostnames (loopback/private) + proxy routing + 256 KB limit.</div></div>
        <div class="spec-row"><div class="spec-key">Storage bridge</div><div class="spec-val">Per-plugin key-value in SettingsStore, 1 MB limit.</div></div>
        <div class="spec-row"><div class="spec-key">Connections bridge</div><div class="spec-val">Owner-scoped (<code>{ownerId}.{connId}</code>). Auto-rendered setup UI in <code>/tools</code> overlay.</div></div>
      </div>
    </div>
  </details>
</div>


<!-- ═══════════════ S2: INTERFACE ═══════════════ -->
<div id="s2" class="sec-head reveal">Interface</div>

<h3 id="s2-ui" class="reveal">User Interface</h3>
<p class="card-desc reveal" style="margin-bottom:8px">
  <code>PiSidebar</code> <span style="color:var(--faint);font-size:12px">(1,221 lines · LitElement · 350px)</span> — purpose-built for Excel's narrow taskpane. Replaces pi-web-ui's ChatPanel + AgentInterface.
</p>
<div class="card-grid reveal">
  <div class="card" style="padding:14px 16px">
    <div class="card-header" style="margin-bottom:4px">
      <div class="card-icon" style="background:var(--green-light);color:var(--green)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg></div>
      <div class="card-title" style="font-size:13px">Input &amp; Auto-scroll</div>
    </div>
    <div class="card-desc" style="font-size:12px">Auto-grow textarea, send/abort, file drop. Scroll hysteresis: disengage at 32px, re-engage at 20px.</div>
  </div>
  <div class="card" style="padding:14px 16px">
    <div class="card-header" style="margin-bottom:4px">
      <div class="card-icon" style="background:var(--blue-light);color:var(--blue)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg></div>
      <div class="card-title" style="font-size:13px">11 Overlay Types</div>
    </div>
    <div class="card-desc" style="font-size:12px">Rules, settings, recovery, extensions hub, files, shortcuts… Single-instance, Escape close, focus restore.</div>
  </div>
  <div class="card" style="padding:14px 16px">
    <div class="card-header" style="margin-bottom:4px">
      <div class="card-icon" style="background:var(--amber-light);color:var(--amber)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg></div>
      <div class="card-title" style="font-size:13px">Status Bar</div>
    </div>
    <div class="card-desc" style="font-size:12px">Context token %, thinking level flash, execution mode badge</div>
  </div>
  <div class="card" style="padding:14px 16px">
    <div class="card-header" style="margin-bottom:4px">
      <div class="card-icon" style="background:var(--violet-light);color:var(--violet)"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg></div>
      <div class="card-title" style="font-size:13px">28+ Slash Commands</div>
    </div>
    <div class="card-desc" style="font-size:12px">model, settings, compact, export, session, help, extensions, tools, skills, files, experimental, debug…</div>
  </div>
</div>

<h3 class="reveal" style="margin-top:18px">Keyboard Shortcuts</h3>
<div class="kbd-grid reveal">
  <div class="kbd-row"><kbd>F2</kbd> <span class="kbd-desc">Focus input</span></div>
  <div class="kbd-row"><kbd>Esc</kbd> <span class="kbd-desc">Blur editor / abort stream</span></div>
  <div class="kbd-row"><kbd>⌘/Ctrl+T</kbd> <span class="kbd-desc">New tab</span></div>
  <div class="kbd-row"><kbd>⌘/Ctrl+W</kbd> <span class="kbd-desc">Close tab</span></div>
  <div class="kbd-row"><kbd>⌘/Ctrl+Shift+T</kbd> <span class="kbd-desc">Reopen closed tab</span></div>
  <div class="kbd-row"><kbd>⌘/Ctrl+Z</kbd> <span class="kbd-desc">Undo close tab</span></div>
  <div class="kbd-row"><kbd>Enter</kbd> <span class="kbd-desc">Send / steer (while streaming)</span></div>
  <div class="kbd-row"><kbd>Alt+Enter</kbd> <span class="kbd-desc">Queue follow-up (while streaming)</span></div>
  <div class="kbd-row"><kbd>Alt+↑</kbd> <span class="kbd-desc">Restore queued messages to editor</span></div>
  <div class="kbd-row"><kbd>Shift+Tab</kbd> <span class="kbd-desc">Cycle thinking level</span></div>
  <div class="kbd-row"><kbd>⌘/Ctrl+O</kbd> <span class="kbd-desc">Toggle details visibility</span></div>
  <div class="kbd-row"><kbd>/</kbd> <span class="kbd-desc">Command menu</span></div>
</div>



<h3 id="s2-agent" class="reveal" style="margin-top:22px">Agent Interface</h3>
<p class="card-desc reveal" style="margin-bottom:12px">
  What the model sees — Pi's awareness is layered. Some context is always present, some is injected fresh each turn, and some is fetched on demand via tools.
</p>

<div class="awareness reveal">
  <div class="awareness__layer awareness__layer--core">
    <div class="awareness__bar">
      <span class="awareness__freq">Always in prompt</span>
    </div>
    <div class="awareness__items">
      <span class="awareness__tag" style="--tag-clr:var(--green)">Identity &amp; persona</span>
      <span class="awareness__tag" style="--tag-clr:var(--blue)">24 tool schemas</span>
      <span class="awareness__tag" style="--tag-clr:var(--amber)">Workflow rules</span>
      <span class="awareness__tag" style="--tag-clr:var(--violet)">Conventions &amp; styles</span>
      <span class="awareness__tag" style="--tag-clr:var(--cyan)">Execution mode</span>
      <span class="awareness__tag" style="--tag-clr:var(--rose)">User instructions</span>
      <span class="awareness__tag" style="--tag-clr:var(--rose)">Workbook instructions</span>
      <span class="awareness__tag" style="--tag-clr:var(--green)">Bridge status</span>
      <span class="awareness__tag" style="--tag-clr:var(--violet)">Skill catalog</span>
    </div>
    <div class="awareness__note">Static prefix — cached by provider. Changes invalidate the entire cache.</div>
  </div>
  <div class="awareness__layer awareness__layer--turn">
    <div class="awareness__bar">
      <span class="awareness__freq">Injected each turn</span>
    </div>
    <div class="awareness__items">
      <span class="awareness__tag" style="--tag-clr:var(--cyan)">Workbook blueprint</span>
      <span class="awareness__tag" style="--tag-clr:var(--amber)">Selection ±5 rows</span>
      <span class="awareness__tag" style="--tag-clr:var(--rose)">Recent cell changes</span>
      <span class="awareness__tag" style="--tag-clr:var(--green)">Workspace file summary</span>
    </div>
    <div class="awareness__note">Auto-context — spliced before the user message. Blueprint only re-sent on structure change or workbook switch.</div>
  </div>
  <div class="awareness__layer awareness__layer--demand">
    <div class="awareness__bar">
      <span class="awareness__freq">On demand via tools</span>
    </div>
    <div class="awareness__items">
      <span class="awareness__tag" style="--tag-clr:var(--green)">Read any range</span>
      <span class="awareness__tag" style="--tag-clr:var(--green)">Search cells</span>
      <span class="awareness__tag" style="--tag-clr:var(--green)">Trace formulas</span>
      <span class="awareness__tag" style="--tag-clr:var(--amber)">Read workspace files</span>
      <span class="awareness__tag" style="--tag-clr:var(--violet)">Read skill docs</span>
      <span class="awareness__tag" style="--tag-clr:var(--blue)">Web search &amp; fetch</span>
      <span class="awareness__tag" style="--tag-clr:var(--cyan)">Run Python</span>
      <span class="awareness__tag" style="--tag-clr:var(--cyan)">Terminal sessions</span>
      <span class="awareness__tag" style="--tag-clr:var(--violet)">MCP servers</span>
    </div>
    <div class="awareness__note">Agent decides when to call tools. Results enter conversation history and become part of the cached prefix on subsequent turns.</div>
  </div>
  <div class="awareness__layer awareness__layer--persist">
    <div class="awareness__bar">
      <span class="awareness__freq">Persists across sessions</span>
    </div>
    <div class="awareness__items">
      <span class="awareness__tag" style="--tag-clr:var(--amber)">Workspace files</span>
      <span class="awareness__tag" style="--tag-clr:var(--rose)">User &amp; workbook rules</span>
      <span class="awareness__tag" style="--tag-clr:var(--violet)">Convention presets</span>
      <span class="awareness__tag" style="--tag-clr:var(--green)">Recovery snapshots</span>
      <span class="awareness__tag" style="--tag-clr:var(--blue)">Session history</span>
    </div>
    <div class="awareness__note">Survives compaction and restarts. <code>notes/index.md</code> is the memory entry point for new sessions.</div>
  </div>
</div>

<!-- ── S2-RULES: Rules & Conventions ── -->
<h3 id="s2-rules" class="reveal" style="margin-top:22px">Rules &amp; Conventions</h3>
<p class="reveal" style="color:var(--muted); font-size:13.5px; line-height:1.6; max-width:620px; margin-bottom:16px">
  Two persistence layers that shape the agent's behavior. <strong>Rules</strong> are free-text guidance
  (what to do); <strong>conventions</strong> are structured formatting defaults (how to format).
  Both survive across sessions.
</p>

<div class="reveal rc-grid">

  <!-- ── Rules ── -->
  <div class="rc-panel" style="--rc-accent:var(--amber)">
    <div class="rc-head">
      <svg class="rc-head__icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 12h-5"/><path d="M15 8h-5"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2"/></svg>
      <span class="rc-head__title">Rules</span>
      <code class="rc-head__tool">instructions</code>
    </div>
    <div class="rc-desc">Injected into system prompt. Works like <code>AGENTS.md</code> — <code>append</code> or <code>replace</code>, ask on conflict.</div>

    <div class="rc-scopes rc-scopes--h">
      <div class="rc-scope">
        <div class="rc-scope__head">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
          <span class="rc-scope__name">User scope</span>
          <span class="rc-scope__badge">2 K</span>
        </div>
        <div class="rc-scope__desc">"All my files" — private to this machine. Auto-updated on preferences.</div>
      </div>
      <div class="rc-scope">
        <div class="rc-scope__head">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></svg>
          <span class="rc-scope__name">Workbook scope</span>
          <span class="rc-scope__badge">4 K</span>
        </div>
        <div class="rc-scope__desc">"This file" — keyed by workbook identity. Explicit confirmation required.</div>
      </div>
    </div>
  </div>

  <!-- ── Conventions ── -->
  <div class="rc-panel" style="--rc-accent:var(--violet)">
    <div class="rc-head">
      <svg class="rc-head__icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5" fill="var(--violet)"/><circle cx="17.5" cy="10.5" r=".5" fill="var(--violet)"/><circle cx="8.5" cy="7.5" r=".5" fill="var(--violet)"/><circle cx="6.5" cy="12" r=".5" fill="var(--violet)"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
      <span class="rc-head__title">Conventions</span>
      <code class="rc-head__tool">conventions</code>
    </div>
    <div class="rc-desc">Overrides surfaced in system prompt; applied by tools at execution time.</div>

    <div class="rc-chips">
      <span class="rc-chip" style="--chip-clr:var(--blue)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
        Number presets <span class="rc-chip__count">6</span>
      </span>
      <span class="rc-chip" style="--chip-clr:var(--violet)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.84Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>
        Named styles <span class="rc-chip__count">11</span>
      </span>
      <span class="rc-chip" style="--chip-clr:var(--green)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>
        Visual defaults
      </span>
      <span class="rc-chip" style="--chip-clr:var(--rose)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>
        Color coding
      </span>
      <span class="rc-chip" style="--chip-clr:var(--amber)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
        Custom presets
      </span>
    </div>
  </div>

</div>


<!-- ═══════════════ S3: MODEL LAYER ═══════════════ -->
<div id="s3" class="sec-head reveal">Model Layer</div>

<h3 id="s3-llm" class="reveal">LLM Pipeline</h3>
<p class="card-desc reveal" style="margin-bottom:14px">
  From browser to model endpoint — authentication, proxy routing, and stream normalization.
</p>

<h3 class="reveal">5 Browser OAuth Providers</h3>

<div class="tool-table-wrap reveal">
  <table class="tool-table ext-table">
    <thead><tr><th style="width:38px"></th><th>Provider</th><th>Flow</th><th>Routing</th></tr></thead>
    <tbody>
      <tr>
        <td class="ext-accent" style="background:var(--orange-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></td>
        <td class="t-name" style="color:var(--orange)">Anthropic</td>
        <td class="t-desc">PKCE</td>
        <td class="t-desc">Proxy for OAuth tokens (<code>sk-ant-oat-*</code>); API keys direct</td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--blue-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></td>
        <td class="t-name" style="color:var(--blue)">OpenAI Codex</td>
        <td class="t-desc">PKCE + JWT</td>
        <td class="t-desc">Always proxy-routed; JWT decode for ChatGPT account ID</td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--green-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></td>
        <td class="t-name" style="color:var(--green)">Google Gemini CLI</td>
        <td class="t-desc">Code Assist</td>
        <td class="t-desc">Tiered provisioning (free/legacy/standard), LRO polling, VPC SC handling</td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--amber-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></td>
        <td class="t-name" style="color:var(--amber)">Google Antigravity</td>
        <td class="t-desc">API key</td>
        <td class="t-desc">2 endpoints (prod + sandbox), default fallback project. JSON <code>{token, projectId}</code></td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--violet-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></td>
        <td class="t-name" style="color:var(--violet)">GitHub Copilot</td>
        <td class="t-desc">Device code</td>
        <td class="t-desc">Token refresh via GitHub API</td>
      </tr>
    </tbody>
  </table>
</div>

<details class="reveal">
  <summary>Stream Proxy (<code>createOfficeStreamFn</code>)</summary>
  <div class="inner">
    <div class="spec-list spec-list--flush">
      <div class="spec-row"><div class="spec-key">Intercept</div><div class="spec-val">Every LLM call — routing, model normalization, tool bundle selection</div></div>
      <div class="spec-row"><div class="spec-key">Proxy routing</div><div class="spec-val">Anthropic OAuth, OpenAI Codex, Google Code Assist, Z-AI, custom gateways</div></div>
      <div class="spec-row"><div class="spec-key">Normalization</div><div class="spec-val">Google preview models → stable fallback, Antigravity → Code Assist base URL</div></div>
      <div class="spec-row"><div class="spec-key">Payload stats</div><div class="spec-val">24-entry ring buffer + 24-session LRU context cache</div></div>
      <div class="spec-row"><div class="spec-key">Churn tracking</div><div class="spec-val">FNV-1a fingerprint of model + systemPrompt + tools hashes per session</div></div>
    </div>
  </div>
</details>

<details class="reveal">
  <summary>CORS Proxy (fetch interceptor)</summary>
  <div class="inner">
    <div class="spec-list spec-list--flush">
      <div class="spec-row"><div class="spec-key">Dev</div><div class="spec-val">Vite reverse proxies — 11 rewrite rules for Anthropic / OpenAI / Google / GitHub endpoints</div></div>
      <div class="spec-row"><div class="spec-key">Production</div><div class="spec-val">User-configured CORS proxy (localhost:3003 default). Conservative endpoint matching</div></div>
      <div class="spec-row"><div class="spec-key">Hygiene</div><div class="spec-val">Strips <code>anthropic-dangerous-direct-browser-access</code> header when proxied</div></div>
      <div class="spec-row"><div class="spec-key">Cache</div><div class="spec-val">3s settings cache for performance</div></div>
    </div>
  </div>
</details>


<h3 id="s3-cache" class="reveal" style="margin-top:22px">Prompt Caching</h3>

<p class="card-desc reveal" style="margin-bottom:12px">
  LLM prompt caching is <strong>prefix-based</strong> — providers cache the longest matching token prefix and reuse it on subsequent calls. Pi keeps the prompt structured so the prefix stays stable and the cache extends as far as possible each turn.
</p>

<!-- Prompt anatomy: 3 zones showing caching behaviour -->
<div class="prefix-anatomy reveal">
  <!-- Zone 1: Prefix anchor -->
  <div class="prefix-zone prefix-zone--frozen">
    <div class="prefix-zone__bar">
      <span class="prefix-zone__label">Prefix anchor</span>
      <span class="prefix-zone__badge">FNV-1a fingerprinted per call</span>
    </div>
    <div class="prefix-zone__slots">
      <div class="prefix-slot" style="--slot-clr:var(--amber)"><span class="prefix-slot__tag">model</span> identity hash</div>
      <div class="prefix-slot" style="--slot-clr:var(--violet)"><span class="prefix-slot__tag">system</span> prompt hash — identity · tool docs · workflow policy · conventions</div>
      <div class="prefix-slot" style="--slot-clr:var(--cyan)"><span class="prefix-slot__tag">tools</span> schema hash — full bundle in fixed order, never sub-setted</div>
    </div>
    <div class="prefix-zone__note">If any hash changes → entire cache invalidated (all history recomputed). <code>PrefixChangeReason</code> recorded &amp; counter incremented.</div>
  </div>
  <hr class="prefix-zone-divider">
  <!-- Zone 2: Conversation history (incrementally cached) -->
  <div class="prefix-zone prefix-zone--history">
    <div class="prefix-zone__bar">
      <span class="prefix-zone__label">Previous turns</span>
      <span class="prefix-zone__badge" style="background:oklch(0.93 0 0)">incrementally cached</span>
    </div>
    <div class="prefix-tail-slices">
      <div class="prefix-tail-slice prefix-tail-slice--dim">
        <span class="prefix-tail-slice__icon" style="color:var(--muted)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
        <span class="prefix-tail-slice__name">Per turn</span>
        <span class="prefix-tail-slice__desc">Auto-context injection · user message · assistant response (thinking + text) · tool calls · tool results. Grows each turn — provider extends the cached prefix automatically.</span>
      </div>
    </div>
    <div class="prefix-zone__note">If history is rewritten (e.g. compaction), cache breaks from the first changed token onward.</div>
  </div>
  <hr class="prefix-zone-divider">
  <!-- Zone 3: Current turn (new content, cached after response for next turn) -->
  <div class="prefix-zone prefix-zone--fresh">
    <div class="prefix-zone__bar">
      <span class="prefix-zone__label">Current turn</span>
      <span class="prefix-zone__badge" style="background:oklch(0.92 0.02 140)">cached for next turn</span>
    </div>
    <div class="prefix-tail-slices">
      <div class="prefix-tail-slice">
        <span class="prefix-tail-slice__icon" style="color:var(--cyan)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg></span>
        <span class="prefix-tail-slice__name">Blueprint</span>
        <span class="prefix-tail-slice__desc"><code>buildOverview()</code> cached per workbook, monotonic revision. Re-injected on structural changes.</span>
      </div>
      <div class="prefix-tail-slice">
        <span class="prefix-tail-slice__icon" style="color:var(--green)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></svg></span>
        <span class="prefix-tail-slice__name">Workspace files</span>
        <span class="prefix-tail-slice__desc">Summary of files in OPFS / native / memory — data, docs, artifacts.</span>
      </div>
      <div class="prefix-tail-slice">
        <span class="prefix-tail-slice__icon" style="color:var(--amber)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></span>
        <span class="prefix-tail-slice__name">Selection</span>
        <span class="prefix-tail-slice__desc">Auto-read ±5 rows around active cell. Formulas highlighted, errors flagged.</span>
      </div>
      <div class="prefix-tail-slice">
        <span class="prefix-tail-slice__icon" style="color:var(--rose)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg></span>
        <span class="prefix-tail-slice__name">Changes</span>
        <span class="prefix-tail-slice__desc"><code>onChanged</code> events → dedup by cell → truncate at 50 → flush on send.</span>
      </div>
      <hr class="prefix-tail-divider">
      <div class="prefix-tail-slice">
        <span class="prefix-tail-slice__icon" style="color:var(--muted)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></span>
        <span class="prefix-tail-slice__name">User message</span>
        <span class="prefix-tail-slice__desc">Current prompt — spliced after auto-context injection.</span>
      </div>
    </div>
  </div>
</div>

<h3 class="reveal" style="margin-top:22px">Stability invariants</h3>

<div class="invariant-list reveal">
  <div class="invariant-row">
    <div class="invariant-check" style="color:var(--amber)">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="invariant-body">
      <span class="invariant-name">Static system prompt</span>
      <span class="invariant-desc">Built from fixed sections (identity, tool docs, policy). Structure only changes on explicit user actions, not per-turn.</span>
    </div>
  </div>
  <div class="invariant-row">
    <div class="invariant-check" style="color:var(--violet)">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="invariant-body">
      <span class="invariant-name">Deterministic tool ordering</span>
      <span class="invariant-desc"><code>selectToolBundle()</code> returns full list in fixed order — no intent-based sub-setting. Extension revision tracking: hot-reloads skip <code>setTools()</code> when schema unchanged. <code style="font-size:11px;opacity:.6">src/context/tool-disclosure.ts</code></span>
    </div>
  </div>
  <div class="invariant-row">
    <div class="invariant-check" style="color:var(--green)">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="invariant-body">
      <span class="invariant-name">Volatile state in message tail only</span>
      <span class="invariant-desc">Auto-context (selection, changes, blueprint) injected as a user message <em>after</em> the frozen prefix — never by mutating the system prompt.</span>
    </div>
  </div>
  <div class="invariant-row">
    <div class="invariant-check" style="color:var(--cyan)">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
    </div>
    <div class="invariant-body">
      <span class="invariant-name">Runtime tool fingerprinting</span>
      <span class="invariant-desc">Refresh passes rebuild tool objects but only call <code>agent.setTools()</code> when the metadata fingerprint actually differs. Schema-stable handler swaps are silent no-ops. <code style="font-size:11px;opacity:.6">src/taskpane/runtime-utils.ts</code></span>
    </div>
  </div>
</div>

<details class="reveal" style="margin-top:12px">
  <summary>Compaction Strategy</summary>
  <div class="inner">
    <div class="spec-list spec-list--flush">
      <div class="spec-row"><div class="spec-key">Quality caps</div><div class="spec-val"><strong>88%</strong> of context for ≥128K models, <strong>85%</strong> for ≥200K</div></div>
      <div class="spec-row"><div class="spec-key">Auto-compact</div><div class="spec-val">Before each user prompt if projected tokens exceed hard threshold (requires ≥4 messages)</div></div>
      <div class="spec-row"><div class="spec-key">Soft warning</div><div class="spec-val">At hard threshold − 5% (min 2K tokens), floors at 70%</div></div>
      <div class="spec-row"><div class="spec-key">Memory nudge</div><div class="spec-val">Regex-detects "remember this" → extracts up to 3 snippets (180 chars) → focus instruction in compaction summary</div></div>
      <div class="spec-row"><div class="spec-key">Result shaping</div><div class="spec-val">6 most recent tool results intact, older &gt;1200 chars → 500-char preview</div></div>
    </div>
  </div>
</details>

<details class="reveal">
  <summary>Known prefix change triggers</summary>
  <div class="inner">
    <div class="spec-list spec-list--flush">
      <div class="spec-row"><div class="spec-key" style="color:var(--green)">Repeated turns</div><div class="spec-val">No churn (cache hit)</div></div>
      <div class="spec-row"><div class="spec-key">/model switch</div><div class="spec-val"><code>["model"]</code></div></div>
      <div class="spec-row"><div class="spec-key">Rules / exec mode</div><div class="spec-val"><code>["systemPrompt"]</code></div></div>
      <div class="spec-row"><div class="spec-key">Skill toggle</div><div class="spec-val"><code>["systemPrompt"]</code></div></div>
      <div class="spec-row"><div class="spec-key">Integration toggle</div><div class="spec-val"><code>["systemPrompt", "tools"]</code></div></div>
      <div class="spec-row"><div class="spec-key">Extension add/remove</div><div class="spec-val">includes <code>"tools"</code></div></div>
      <div class="spec-row"><div class="spec-key" style="color:var(--green)">Extension hot-reload</div><div class="spec-val">No churn (same schema)</div></div>
      <div class="spec-row"><div class="spec-key" style="color:var(--green)">Extension side call</div><div class="spec-val">Isolated session key — no main-session churn</div></div>
    </div>
    <p style="margin-top:10px;font-size:13px;color:var(--muted)">Baseline matrix documented in <code>docs/cache-observability-baselines.md</code>. PRs that change context shape must include a cache observability check.</p>
  </div>
</details>


<!-- ═══════════════ S4: LIFECYCLE ═══════════════ -->
<div id="s4" class="sec-head reveal">Lifecycle</div>

<h3 id="s4-session" class="reveal">Session Runtime</h3>
<p class="card-desc reveal" style="margin-bottom:6px">
  Each tab = one <code>SessionRuntime</code> with its own Agent, ActionQueue, QueueDisplay, and SessionPersistenceController. Multi-tab layout persisted per workbook.
</p>
<div class="spec-list reveal">
  <div class="spec-row">
    <div class="spec-key">Tabs</div>
    <div class="spec-val">Create, close, rename, reorder, duplicate, restore recently closed (stack of 10)</div>
  </div>
  <div class="spec-row">
    <div class="spec-key">Lock state</div>
    <div class="spec-val"><code>idle</code> → <code>waiting_for_lock</code> → <code>holding_lock</code> — prevents concurrent writes</div>
  </div>
  <div class="spec-row">
    <div class="spec-key">Association</div>
    <div class="spec-val">Session ↔ workbook is write-once (no accidental move on resume)</div>
  </div>
  <div class="spec-row">
    <div class="spec-key">Restore</div>
    <div class="spec-val">Partitions sessions: matching / unlinked / foreign</div>
  </div>
  <div class="spec-row">
    <div class="spec-key">Queue</div>
    <div class="spec-val">FIFO for prompts + commands. Guards against <code>/compact</code> race (<code>agent.streamFn()</code> outside Agent loop). Auto-compaction before each prompt.</div>
  </div>
</div>



<h3 id="s4-boot" class="reveal" style="margin-top:22px">Boot Sequence</h3>
<p class="card-desc reveal" style="margin-bottom:14px">
  <code>bootstrap.ts</code> → <code>initTaskpane()</code> — 7 phases with timeouts and fallbacks for non-Excel environments (dev mode).
</p>

<div class="boot-rail reveal">
  <div class="boot-phase boot-phase--gate">
    <span class="boot-dot">1</span>
    <div class="boot-name">Global Patches</div>
    <ul class="boot-items">
      <li>Render loading UI</li>
      <li><code>process.env</code> shim, fetch interceptor (CORS proxy), model-selector patch</li>
      <li><code>Office.onReady()</code> <span class="boot-badge">3 s fallback</span> for dev without Excel</li>
      <li>Call <code>initTaskpane()</code> <span class="boot-badge">60 s hard timeout</span></li>
    </ul>
  </div>
  <div class="boot-phase">
    <span class="boot-dot">2</span>
    <div class="boot-name">Storage &amp; Migrations</div>
    <ul class="boot-items">
      <li>SettingsStore init + proxy default seed</li>
      <li>Legacy migrations: web-search API keys → ConnectionStore, MCP tokens → ConnectionStore</li>
      <li>Remote proxy security warning</li>
    </ul>
  </div>
  <div class="boot-phase">
    <span class="boot-dot">3</span>
    <div class="boot-name">Auth &amp; Credentials</div>
    <ul class="boot-items">
      <li>Provider discovery (5 built-in + custom gateways)</li>
      <li>Credential restore: <code>pi auth.json</code> (dev) or IndexedDB OAuth (prod) <span class="boot-badge">6 s timeout</span></li>
      <li>Auto-refresh expired tokens</li>
      <li>Show welcome login overlay if no providers</li>
    </ul>
  </div>
  <div class="boot-phase">
    <span class="boot-dot">4</span>
    <div class="boot-name">Core Infrastructure</div>
    <ul class="boot-items">
      <li><code>ChangeTracker.start()</code> — cell change monitoring</li>
      <li><code>createOfficeStreamFn()</code> — LLM call interceptor</li>
      <li><code>createWorkbookCoordinator()</code> — FIFO write queue</li>
    </ul>
  </div>
  <div class="boot-phase">
    <span class="boot-dot">5</span>
    <div class="boot-name">UI Mount &amp; Managers</div>
    <ul class="boot-items">
      <li><code>PiSidebar</code> mount + execution mode controller</li>
      <li><code>ConnectionManager</code> + <code>ExtensionRuntimeManager</code> (reserved tool names from core + integrations)</li>
    </ul>
  </div>
  <div class="boot-phase">
    <span class="boot-dot">6</span>
    <div class="boot-name">Runtime Factory</div>
    <ul class="boot-items">
      <li>Bridge health probe (async — first turn waits for result)</li>
      <li>Runtime factory wiring</li>
      <li>Tab layout restore from SettingsStore (or create first runtime)</li>
    </ul>
  </div>
  <div class="boot-phase boot-phase--gate">
    <span class="boot-dot">7</span>
    <div class="boot-name">Extensions &amp; UI Polish</div>
    <ul class="boot-items">
      <li>Extension init <span class="boot-badge">5 s timeout</span> non-blocking</li>
      <li>Keyboard shortcuts, status bar, command menu</li>
      <li>Proxy polling <span class="boot-badge">30 s interval</span></li>
      <li>Disclosure bar + proxy banner</li>
    </ul>
  </div>
</div>


<!-- ═══════════════ S5: SAFETY & RECOVERY ═══════════════ -->
<div id="s5" class="sec-head reveal">Safety &amp; Recovery</div>

<p class="card-desc reveal" style="margin-bottom:14px">6 defense boundaries — each enforced independently, no single-point-of-failure.</p>

<div class="defense-list reveal">
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--rose-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--rose)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--rose)">SSRF Protection</div>
      <div class="defense-desc">Proxy target policy: hostname check + DNS-resolved IP check. Blocks loopback (<code>127.0.0.0/8</code>, <code>::1</code>), RFC1918, link-local. IPv4-mapped-IPv6 handling.</div>
    </div>
  </div>
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--amber-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--amber)">Markdown Safety</div>
      <div class="defense-desc">Global marked patch: block <code>javascript:</code> / <code>data:</code> / <code>file:</code> links. No <code>&lt;img&gt;</code> from markdown (exfiltration risk → clickable link). Disable <code>$...$</code> KaTeX (currency collision).</div>
    </div>
  </div>
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--blue-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="16" r="1"/><rect x="3" y="10" width="18" height="12" rx="2"/><path d="M7 10V7a5 5 0 0 1 10 0v3"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--blue)">Bridge Security</div>
      <div class="defense-desc">CORS origin allowlist, Bearer token auth (timing-safe compare), loopback-only binding, 512KB body limit, 256KB output limit, process timeout with SIGKILL.</div>
    </div>
  </div>
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--violet-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v2z"/><path d="M10 10V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5"/><path d="M4 15v-3a6 6 0 0 1 6-6h0"/><path d="M14 6h0a6 6 0 0 1 6 6v3"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--violet)">Extension Sandbox</div>
      <div class="defense-desc">Inline/remote code runs in sandboxed iframe with CSP. postMessage RPC for all 18 API surfaces. Allowlisted UI tag set. URL validation for HTTP requests.</div>
    </div>
  </div>
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--green-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 16 4-4-4-4"/><path d="m6 8-4 4 4 4"/><path d="m14.5 4-5 16"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--green)">HTML Safety</div>
      <div class="defense-desc">No <code>innerHTML</code> for user/tool/session content — DOM APIs or <code>escapeHtml()</code> / <code>escapeAttr()</code>. Queue display explicitly avoids innerHTML.</div>
    </div>
  </div>
  <div class="defense-row">
    <div class="defense-icon" style="background:var(--orange-light)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/></svg>
    </div>
    <div class="defense-body">
      <div class="defense-name" style="color:var(--orange)">Secret Redaction</div>
      <div class="defense-desc">Connection secrets never exposed to UI (presence flags only). Error messages auto-redacted: stored values → <code>••••</code>. OAuth tokens in IndexedDB.</div>
    </div>
  </div>
</div>

<h3 class="reveal" style="margin-top:22px">Mutation Finalization</h3>
<p class="card-desc reveal" style="margin-bottom:4px">Every mutation tool calls <code>finalizeMutationOperation()</code>:</p>
<div class="timeline reveal">
  <div class="tl-step">
    <div class="tl-dot" style="background:var(--green-light);color:var(--green)">1</div>
    <div class="tl-label">Append audit entry</div>
    <div class="tl-detail"><code>WorkbookChangeAuditLog</code>: persistent, 500-entry rotating, tagged with execution mode + workbook identity</div>
  </div>
  <div class="tl-step">
    <div class="tl-dot" style="background:var(--blue-light);color:var(--blue)">2</div>
    <div class="tl-label">Recovery snapshot <span style="font-weight:400;color:var(--faint)">(optional)</span></div>
    <div class="tl-detail">Deep-clone state → stamp <code>result.details.recovery</code> → dispatch created event or append unavailable note</div>
  </div>
  <div class="tl-step">
    <div class="tl-dot" style="background:var(--amber-light);color:var(--amber)">3</div>
    <div class="tl-label">Change explanation</div>
    <div class="tl-detail">Deterministic from audit metadata (no LLM call), bounded 420 chars, up to 8 citations</div>
  </div>
</div>

<h3 class="reveal" style="margin-top:18px">5 Snapshot Kinds</h3>
<div class="snap-grid reveal">
  <div class="snap-tile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></svg>
    <div class="snap-name">Range</div>
    <div class="snap-desc">Values + formulas grid capture</div>
  </div>
  <div class="snap-tile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>
    <div class="snap-name">Format</div>
    <div class="snap-desc">20 properties via boolean mask</div>
  </div>
  <div class="snap-tile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="7" x="3" y="3" rx="1"/><rect width="9" height="7" x="3" y="14" rx="1"/><rect width="5" height="7" x="16" y="14" rx="1"/></svg>
    <div class="snap-name">Structure</div>
    <div class="snap-desc">Rows, columns, sheets + data</div>
  </div>
  <div class="snap-tile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--rose)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20h.01"/><path d="M7 20v-4"/><path d="M12 20v-8"/><path d="M17 20V8"/><path d="M22 4v16"/></svg>
    <div class="snap-name">Cond. Format</div>
    <div class="snap-desc">8 rule types, 20 icon styles</div>
  </div>
  <div class="snap-tile">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--violet)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
    <div class="snap-name">Comment</div>
    <div class="snap-desc">Full thread + replies</div>
  </div>
</div>
<p class="card-desc reveal" style="margin-top:4px">
  <strong>Restore</strong> creates an inverse snapshot before applying — enables "undo the undo". <code>save-boundary-monitor</code> polls <code>Workbook.isDirty</code> every 4s, clears checkpoints on user save.
</p>

<h3 class="reveal" style="margin-top:18px">Manual Full Backup</h3>
<p class="card-desc reveal">
  <code>Office.getFileAsync("compressed")</code> → 1MB chunks → base64 → workspace file. Stored under <code>manual-backups/full-workbook/v1/</code>.
</p>


<!-- ═══════════════ S6: TESTING ═══════════════ -->
<div id="s6" class="sec-head reveal">Testing Strategy</div>

<div class="stats reveal" style="padding-top:0;margin-bottom:14px">
  <div class="stat">
    <div class="stat-value">100</div>
    <div class="stat-label">Test files</div>
  </div>
  <div class="stat">
    <div class="stat-value">3</div>
    <div class="stat-label">Suites</div>
  </div>
  <div class="stat">
    <div class="stat-value" style="font-size:16px">node:test</div>
    <div class="stat-label">Runner</div>
  </div>
  <div class="stat">
    <div class="stat-value" style="font-size:16px">DI</div>
    <div class="stat-label">Mock strategy</div>
  </div>
</div>

<div class="tool-table-wrap reveal">
  <table class="tool-table ext-table">
    <thead><tr><th style="width:38px"></th><th>Suite</th><th>Files</th><th>Coverage</th></tr></thead>
    <tbody>
      <tr>
        <td class="ext-accent" style="background:var(--cyan-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--cyan)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 20.66-1-1.73"/><path d="M11 10.27 7 3.34"/><path d="m20.66 17-1.73-1"/><path d="m3.34 7 1.73 1"/><path d="M14 12h8"/><path d="M2 12h2"/><path d="m20.66 7-1.73 1"/><path d="m3.34 17 1.73-1"/><path d="m17 3.34-1 1.73"/><path d="m11 13.73-4 6.93"/></svg></td>
        <td class="t-name" style="color:var(--cyan)">test:models</td>
        <td class="t-desc">Fast</td>
        <td class="t-desc">Provider priority, family priority, <code>parseMajorMinor</code></td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--green-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg></td>
        <td class="t-name" style="color:var(--green)">test:context</td>
        <td class="t-desc">~80 files</td>
        <td class="t-desc">Tools, context injection, compaction, change tracker, session persistence, blueprint, recovery</td>
      </tr>
      <tr>
        <td class="ext-accent" style="background:var(--rose-light)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--rose)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg></td>
        <td class="t-name" style="color:var(--rose)">test:security</td>
        <td class="t-desc">9 files</td>
        <td class="t-desc">SSRF proxy, CORS server, tmux/python bridges, extension source policy, marked safety, OAuth</td>
      </tr>
    </tbody>
  </table>
</div>

<details class="reveal" style="margin-top:12px">
  <summary>Build &amp; Config</summary>
  <div class="inner">
    <div class="spec-list spec-list--flush">
      <div class="spec-row">
        <div class="spec-key">Vite</div>
        <div class="spec-val">HTTPS dev server, pi-auth plugin, stub plugins for heavy Node deps, 11 proxy entries</div>
      </div>
      <div class="spec-row">
        <div class="spec-key">TypeScript</div>
        <div class="spec-val">ES2022 target, strict, bundler moduleResolution, <code>useDefineForClassFields: false</code> for Lit</div>
      </div>
      <div class="spec-row">
        <div class="spec-key">ESLint</div>
        <div class="spec-val">typescript-eslint recommendedTypeChecked, ban <code>ts-ignore</code>, error on floating/misused promises</div>
      </div>
      <div class="spec-row">
        <div class="spec-key">Manifest</div>
        <div class="spec-val">Office TaskPaneApp, ReadWriteDocument permission, Home ribbon button. Dev = localhost:3000, prod = Vercel</div>
      </div>
      <div class="spec-row">
        <div class="spec-key">Pre-commit</div>
        <div class="spec-val"><code>npm run lint</code> + <code>npm run typecheck</code></div>
      </div>
      <div class="spec-row">
        <div class="spec-key">CI checks</div>
        <div class="spec-val">5 custom scripts — inline style hygiene, dead CSS vars, landing page copy, pi dep lockstep, theme utility overrides</div>
      </div>
    </div>
  </div>
</details>




<!-- ═══════════════ CREDITS ═══════════════ -->
<div class="credits reveal">
  <hr class="credits-rule">
  <h3 class="credits-heading">Credits</h3>
  <dl class="credits-list">
    <div class="credits-entry">
      <dt><a href="https://github.com/badlogic/pi-mono" target="_blank" rel="noopener">Pi</a></dt>
      <dd>by <a href="https://github.com/badlogic" target="_blank" rel="noopener">Mario Zechner</a> — the agent framework powering this project. Pi for Excel uses pi-agent-core, pi-ai, and pi-web-ui for the agent loop, LLM abstraction, and session storage.</dd>
    </div>
    <div class="credits-entry">
      <dt><a href="https://github.com/nicobailon/visual-explainer" target="_blank" rel="noopener">visual-explainer</a></dt>
      <dd>by <a href="https://github.com/nicobailon" target="_blank" rel="noopener">Nico Bailon</a> — the Pi extension used to generate this architecture page.</dd>
    </div>
    <div class="credits-entry">
      <dt><a href="https://github.com/mitsuhiko/agent-stuff/blob/main/pi-extensions/whimsical.ts" target="_blank" rel="noopener">whimsical.ts</a></dt>
      <dd>by <a href="https://github.com/mitsuhiko" target="_blank" rel="noopener">Armin Ronacher</a> — the rotating "Working…" messages are adapted from his Pi extension, rewritten for a spreadsheet audience.</dd>
    </div>
  </dl>
</div>

    </div><!-- /main -->
  </div><!-- /content-wrap -->


  <!-- ── Footer (matches landing) ── -->
  <footer>
    <span class="footer-pi">π</span>
    <p>
      Pi for Excel is free, open source, and <a href="https://github.com/tmustier/pi-for-excel/blob/main/LICENSE" target="_blank" rel="noopener">MIT licensed</a>.
      Updates are automatic — close and reopen the sidebar to get the latest version.
    </p>
    <p class="footer-note">
      Built by <a href="https://github.com/tmustier" target="_blank" rel="noopener">Thomas Mustier</a>.
      Powered by <a href="https://pi.dev" target="_blank" rel="noopener">Pi</a>, an extensible coding agent by <a href="https://github.com/badlogic" target="_blank" rel="noopener">Mario Zechner</a>.
    </p>
  </footer>

</div>


<script>
(() => {
  // ── Scroll-reveal (same as landing) ──
  const revealObserver = new IntersectionObserver(
    (entries) => entries.forEach((entry) => {
      if (entry.isIntersecting) entry.target.classList.add('visible');
    }),
    { threshold: 0.08, rootMargin: '0px 0px -30px 0px' },
  );
  document.querySelectorAll('.reveal').forEach((el) => revealObserver.observe(el));

  // ── TOC active tracking (scroll-position based) ──
  const toc = document.getElementById('toc');
  if (!toc) return;
  const links = [...toc.querySelectorAll('a')];

  // Build ordered list of tracked headings (DOM order = scroll order)
  const sections = [];
  links.forEach((link) => {
    const id = link.getAttribute('href')?.slice(1);
    const el = id ? document.getElementById(id) : null;
    if (el) sections.push({ el, link, isSub: link.classList.contains('toc-sub') });
  });

  // Map sub-links → parent (previous non-sub link)
  const parentOf = new Map();
  let currentParent = null;
  links.forEach((link) => {
    if (!link.classList.contains('toc-sub')) currentParent = link;
    else parentOf.set(link, currentParent);
  });

  let lastActive = null;
  function updateTOC() {
    // Find the last heading whose top is above the trigger line (15% from viewport top)
    const trigger = window.scrollY + window.innerHeight * 0.15;
    let active = null;
    for (const s of sections) {
      if (s.el.getBoundingClientRect().top + window.scrollY <= trigger) active = s;
    }
    if (active === lastActive) return;
    lastActive = active;
    links.forEach((l) => { l.classList.remove('active'); l.classList.remove('toc-parent-active'); });
    if (!active) return;
    active.link.classList.add('active');
    const parent = parentOf.get(active.link);
    if (parent) parent.classList.add('toc-parent-active');
    if (window.innerWidth <= 900) {
      (parent || active.link).scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
  }
  window.addEventListener('scroll', updateTOC, { passive: true });
  updateTOC(); // set initial state

  links.forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const id = link.getAttribute('href')?.slice(1);
      const el = id ? document.getElementById(id) : null;
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        history.replaceState(null, '', '#' + id);
      }
    });
  });
})();
</script>

</body>
</html>
